/*!
  * wia router v0.1.11
  * (c) 2020 Sibyl Yu
  * @license MIT
  */
"use strict";function _extends(){return(_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(e[o]=s[o])}return e}).apply(this,arguments)}Object.defineProperty(exports,"__esModule",{value:!0});var location=window.location,API={getCode:"auth/getCode",getToken:"auth/getToken",checkToken:"auth/checkToken"},Router=function(){function Router(e){var t=this;this.opt={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.nuoya.net",api:"https://wia.pub",ver:"1.0.0",mode:"prod",transition:"f7-flip"},this._index=1,this.view=null,this.rs=[],this.ps={},this.url="",this.hash=[],this.splash=!1,this.getCurrentPage=function(){return $.qu("."+t.opt.showClass)},this.opt=$.assign({},this.opt,e),this.app=this.opt.app,this.app.router=this,this.view=$("#"+this.opt.view),this.style=null,this.lastStyle=null,this.param={},this.page=null,this.lastPage=null,$.view=this.view,$.router=this,this.splash=!0,this.lastHash="",this.hash=[],this.nextHash="",this.owner=this.opt.owner,this.name=this.opt.name,this.path="",this.lastOwner="",this.lastName="",this.lastPath="",this.backed=!1,window.addEventListener("hashchange",(function(e){var s=getHash(e.newURL),o=getHash(e.oldURL);console.log("router hash:"+o+" -> "+s);var a=s||"index";if(s===(a=t.repairUrl(a)))if(s!==o){t.backed=!1,t.hash=t.hash||[];var r=t.hash;!r||0===r.length||r.length>0&&r[r.length-1]!==s?(r.length>0?console.log("hash:"+r[r.length-1]+" -> "+s):console.log("hash:null -> "+s),r.push(s)):r.length>1&&r[r.length-2]===s?(t.backed=!0,console.log("back hash:"+r[r.length-2]+" <- "+s),r.pop()):r.length>0&&r[r.length-1]===s&&console.log("same hash: "+s),t.routeTo(r[r.length-1],t.param,t.refresh),t.refresh=!1,t.param=null,t.nextHash=""}else t.nextHash="";else setHash(a)}),!1)}var _proto=Router.prototype;return _proto.go=function(e,t,s){void 0===t&&(t=null),void 0===s&&(s=!1),e=e||"index",e=this.repairUrl(e),getHash(location.href)===e?(this.nextHash=getHash(e),this.hash[this.hash.length-1]!==this.nextHash&&this.hash.push(this.nextHash),this.routeTo(e,t,s)):(this.param=t,this.refresh=s,this.nextHash=e,setHash(e))},_proto.repairUrl=function(e){var t="";if(!e)return"";try{if(t=e,"/"===e)t="/";else if("~"===e)t="/"+this.owner+"/"+this.name+"/index";else if(e.startsWith("./"))t="/"+this.owner+"/"+this.name+"/"+this.path+"/"+e.substr(2);else if(e.startsWith("/")){if(e.startsWith("/")){var s=e.match(/([^/]+)\/([^/]+)\/?([^?]*)([\s\S]*)/);if(s){var o=s[1],a=s[2],r=s[3];o&&a&&!r&&(t="/"+o+"/"+a+"/index"+s[4])}}}else t="/"+this.owner+"/"+this.name+"/"+e;(t=(t=t.endsWith("/")?t+"index":t).replace(/\/\?/g,"index?"))!==e&&console.log("router repairUrl:"+e+" -> "+t)}catch(e){console.error("router repairUrl exp:"+e.message)}return t},_proto.back=function(e,t){void 0===t&&(t=!1),this.param=e,this.refresh=t,window.history.back()},_proto.loaded=function(e){return $.id(e.id)||this.ps[e.id]},_proto.load=function load(url,param){var _this2=this,R=null;try{R=new Promise((function(res,rej){var ps=url.match(/([^/]+)\/([^/]+)\/?([^?]*)/),owner=null==ps?void 0:ps[1],name=null==ps?void 0:ps[2],page=null==ps?void 0:ps[3];owner&&name&&!page&&(page="index");var path="";if(page&&page.includes("/")){var _pos=page.lastIndexOf("/");path=page.substr(0,_pos)}console.log("load",{owner:owner,name:name,page:page,path:path}),owner&&(_this2.owner!==_this2.lastOwner&&(_this2.lastOwner=_this2.owner),_this2.owner=owner),name&&(_this2.name!==_this2.lastName&&(_this2.lastName=_this2.name),_this2.name=name),path&&(_this2.path!==_this2.lastPath&&(_this2.lastPath=_this2.path),_this2.path=path),owner&&name&&page?_this2.switchApp(owner,name,path).then((function(rs){if(rs)if("local"===_this2.opt.mode){var appJs=null,appCss=null,pgHtml=new Promise((function(e,t){var s=_this2.opt.local+"/"+owner+"/"+name+"/page/"+page+".html?v="+Date.now();$.get(s).then((function(t){var s=new(__webpack_require__("./src/page/"+page+".js").default)({app:_this2.app});s.html=t,s.url="/"+owner+"/"+name+"/"+page,s.param=param,_this2.push(s),e(s)}),(function(e){return t(e)}))})),pgCss=new Promise((function(e,t){var s=_this2.opt.local+"/page/"+page+".css?v="+Date.now();$.get(s).then((function(t){e(t)}),(function(e){return t(e)}))}));appJs?Promise.all([appJs,appCss]).then((function(rs){owner&&(_this2.owner!==_this2.lastOwner&&(_this2.lastOwner=_this2.owner),_this2.owner=owner),name&&(_this2.name!==_this2.lastName&&(_this2.lastName=_this2.name),_this2.name=name),_this2.rs=[],eval(rs[0]);var appcss=rs[1];Promise.all([pgHtml,pgCss]).then((function(e){var t=e[0];t.css=e[1],t.load&&t.load(param),res(t)})).catch((function(e){return rej(e)}))})).catch((function(e){return rej(e)})):Promise.all([pgHtml,pgCss]).then((function(e){var t=e[0];t.css=e[1],t.load&&t.load(param),res(t)})).catch((function(e){return rej(e)}))}else{url=url.substring(1,pos)+"/page/"+page;var pgurl=_this2.opt.cos+"/"+url+".js?v="+_this2.opt.ver;$.get(pgurl).then((function(e){var t=JSON.parse(e);if(t&&t.js){var s=Object.keys(t.js)[0];t.js[s];$._m.add(t.js);var o=new($._m(s).default);o.html=t.html,o.css=t.css,o.param=param,$.router.push(o),o.load&&o.load(param),res(o)}}),(function(e){return rej(e)}))}})):res("")}))}catch(e){console.error("load exp:"+e.message)}return R},_proto.switchApp=function(e,t,s){var o=this;return new Promise((function(s,a){var r=!1;try{e===o.owner&&t===o.name?s(!0):o.getToken().then((function(e){e&&(r=!0),s(r)}))}catch(e){console.log("getToken exp:",e.message),s(r)}}))},_proto.getToken=function(e,t){var s=this,o=this;return new Promise((function(a,r){var n="",i=e+"/"+t+"/token";try{var h=$.store.get(i);s.checkToken(e,t,h).then((function(r){r?($.app.token=h,a(h)):(h=$.app.token,$.app.token="",s.getCode(h).then((function(s){s?$.get(o.opt.api+"/"+e+"/"+t+"/"+API.getToken,"code="+s).then((function(e){e&&(console.log("getToken",{r:e}),200===e.code?(h=e.data.token,$.app.token=h,$.store.set(i,h),n=h):console.error("getToken error",{r:e})),a(n)})).catch(a(n)):(console.error("getToken fail! no code."),a(n))})))}))}catch(e){console.error("getToken exp:",e.message)}return n}))},_proto.checkToken=function(e,t,s){var o=this;return new Promise((function(a,r){var n=!1;try{s?$.get(o.opt.api+"/"+e+"/"+t+"/"+API.checkToken,"token="+s).then((function(e){if(console.log("checkToken",{token:s,rs:e}),200===e.code){e.data.expire;n=e.data.res}a(n)})).catch(a(n)):a(n)}catch(e){console.error("checkToken exp:",e.message),a(n)}}))},_proto.getCode=function(e){var t=this;return new Promise((function(s,o){var a="";try{$.get(t.opt.api+"/"+API.getCode,"token="+e).then((function(t){console.log("getCode",{token:e,rs:t}),200===t.code?a=t.data:console.error("getCode fail.",{token:e,rs:t}),s(a)})).catch(s(a))}catch(e){console.error("getCode exp:",e.message),s(a)}}))},_proto.addCss=function(e){var t=document.createElement("style");this.style&&(this.lastStyle=this.style),this.style=t,$("head").append(t),this.style.innerHTML=e},_proto.removeCss=function(){this.lastStyle&&this.lastStyle.parentNode&&this.lastStyle.parentNode.removeChild(this.lastStyle)},_proto.routeTo=function(e,t,s){var o=this;console.log("routeTo ",{url:e,param:t,refresh:s});var a=this.findRoute(e,t,s);a?this.to(a,s):this.load(e,t).then((function(r){(a=o.findRoute(e,t,s))&&o.to(a,s)}))},_proto.to=function(e,t){var s=this;if(!e)return console.error("route to null page."),this;this.lastPage=this.page,this.lastPage&&(this.lastPage.scrollTop=this.lastPage.el.clas("page-content").dom.scrollTop),this.page=e,$.page=this.page,$.lastPage=this.lastPage,this.lasts=this.lasts||[];var o=this.lasts;this.backed=!1,o.length>1&&o[o.length-2].id===e.id?(this.backed=!0,console.log("to back id:"+o[o.length-2].id+" <- "+this.lastPage.id),o.pop()):o.length>0&&o[o.length-1].id===e.id?console.log("to same id: "+e.id):(0===o.length||o.length>0&&o[o.length-1].id!==e.id)&&(o.length>0?console.log("to id:"+o[o.length-1].id+" -> "+e.id):console.log("to id:null -> "+e.id),o.push(this.page));var a=function(t){e.doReady=!1;var o=$.id(e.id);if(!o&&(!(o=s.ps[e.id])&&t&&(o=t,s.ps[e.id]=o,e.doReady=!0),o)){if(s.view){s.addCss(e.css);var a=$(o);s.backed&&s.view.hasChild()?(s.opt.className&&a.addClass(""+s.opt.className),s.opt.prevClass&&a.addClass(""+s.opt.prevClass),s.view.dom.insertBefore(o,s.view.dom.children[0])):(s.opt.className&&a.addClass(""+s.opt.className),s.opt.nextClass&&a.addClass(""+s.opt.nextClass),s.view.dom.appendChild(o))}e.doReady&&$.fastLink()}e.page=o,e.el=$(o),s.nextHash&&s.nextHash!==s.hash[s.hash.length-1]||s.switchPage(s.lastPage,e,s.backed)};if(t){var r=$.id(e.id);r&&$.remove(r),(r=this.ps[e.id])&&delete this.ps[e.id]}var n=this.loaded(e);this.getCurrentPage();return n?a():function(t,s){if(void 0===s&&(s=""),t)throw t;var o=$(s);e.view=o,o.dom.id=e.id,a(o.dom)}(null,e.html),this},_proto.parseUrl=function(e){var t={url:e};try{var s=e.indexOf("?");if(s>=0)if(t.url=e.substr(0,s),t.search=e.substr(s+1),t.search)t.param={},t.search.split("&").forEach((function(e){(s=e.indexOf("="))>0&&(t.param[e.substr(0,s)]=e.substr(s+1))}));t.url=this.repairUrl(t.url),e!==t.url&&console.log("router parseUrl url:"+e+" -> "+t.url)}catch(e){console.error("router parseUrl exp:"+e.message)}return t},_proto.findRoute=function(e,t,s){var o=null,a=this.parseUrl(e),r=this.rs.find((function(e){return e.url===a.url}));return r?(a.param?r.param=_extends({},a.param):r.param={},t&&$.assign(r.param,t),r.path=a.path,r.url=e,r.lastSearch=r.search,r.search=a.search,r.refresh=s,o=r):console.log("findRoute not find!",{url:e}),o},_proto.push=function(e){try{if(!e)throw new Error("page is empty!");if(!e.url)throw new Error("page's url is empty!");return this.rs.find((function(t){return t.url===e.url}))?void console.info("push r.url:"+e.url+" exist."):(e.id=""+e.url.replace(/\//g,"-"),e.id.startsWith("-")&&(e.id=e.id.substr(1)),e.ready=e.ready||$.noop,e.router=this,this.rs.push(e),console.debug("router push r.url:"+e.url+" succ."),this)}catch(e){alert("router.push exp: "+e.message)}},_proto.aniPage=function(e,t,s,o){var a=this,r="router-transition-"+(s||"forward")+" router-transition";if($.device.ios)t.animationEnd((function(){a.view.removeClass(r),o&&o()}));else{var n=t;"backward"===s&&(n=e),n.animationEnd((function(){a.view.removeClass(r),o&&o()}))}this.view.addClass(r)},_proto.hidePage=function(e,t){t&&e&&(t.removeClass(this.opt.showClass),t.removeClass(this.opt.prevClass),t.removeClass(this.opt.nextClass),e.hide&&e.hide(t),e.lastPage&&(this.ps[e.lastPage.id]=t),t.remove(),this.removeCss())},_proto.onShow=function(e,t){var s=this;try{if(!e)return;e.doReady&&e.ready&&$.nextTick((function(){e.ready(t,e.param,s.backed)})),e.back&&this.backed&&$.nextTick((function(){e.scrollTop&&(t.clas("page-content").dom.scrollTop=e.scrollTop),e.back(t,e.param)})),e.show&&!this.backed&&$.nextTick((function(){e.show(t,e.param)}))}catch(e){console.error("onShow ",{ex:e.message})}},_proto.showPage=function(e,t){t&&(t.removeClass(this.opt.nextClass),t.removeClass(this.opt.prevClass),t.addClass(this.opt.showClass))},_proto.switchPage=function(e,t,s){var o=this;if(t){var a=this.getCurrentPage();a&&(a=$(a));var r=$.id(t.id);if(r&&(r=$(r)),!a||!r||a.dom!==r.dom){var n=s?"backward":"forward";(a||r)&&(a&&r?this.noAni?(this.noAni=!1,this.hidePage(e,a),this.onShow(t,r),this.showPage(t,r)):(this.onShow(t,r),this.aniPage(a,r,n,(function(){o.hidePage(e,a),o.showPage(t,r)}))):a?this.hidePage(e,a):r&&(this.onShow(t,r),this.showPage(t,r))),setTitle(this.page.title)}}},Router}();function getHash(e){e||(e=location.href);var t=e.indexOf("#!");return-1!==t?t++:t=e.indexOf("#"),-1!==t?e.substring(t+1):""}function setHash(e){var t=e;"!"!==e[0]&&(t="!"+e),location.hash=t}function setTitle(e){document.title!==e&&(/MicroMessenger/i.test(navigator.userAgent)?setTimeout((function(){document.title=e;var t=document.createElement("iframe");t.style.display="none",t.onload=function(){setTimeout((function(){document.body.removeChild(t)}),0)},document.body.appendChild(t)}),0):document.title=e)}$.go=function(e,t,s){void 0===t&&(t=null),void 0===s&&(s=!1),$.router.go(e,t,s)},$.back=function(e,t){void 0===t&&(t=!1),$.router.back(e,t)},exports.Router=Router;
/*!
  * wia router v0.1.1
  * (c) 2020 Sibyl Yu
  * @license MIT
  */
var t,s;t=this,s=function(){"use strict";let t=window.location;function s(t){if(!t)return"";let s=t.indexOf("#!");return-1!==s?s++:s=t.indexOf("#"),-1!==s?t.substring(s+1):""}return $.go=(t,s=null,e=!1)=>{$.router.go(t,s,e)},$.back=(t=!1)=>{$.router.refresh=t,$.router.back()},class{constructor(t){this.opt={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.nuoya.net",ver:"1.0.0",mode:"prod",transition:"f7-flip"},this._index=1,this.view=null,this.rs=[],this.ps={},this.url="",this.path=[],this.hash=[],this.splash=!1,this.getCurrentPage=()=>$.qu(`.${this.opt.showClass}`),this.opt=$.assign({},this.opt,t),this.app=this.opt.app,this.app.router=this,this.view=$(`#${this.opt.view}`),this.style=null,this.lastStyle=null,this.param={},this.page=null,this.lastPage=null,$.view=this.view,$.router=this,this.splash=!0,this.path=[],this.lastHash="",this.hash=[],this.nextHash="",this.backed=!1,window.addEventListener("hashchange",t=>{const e=s(t.newURL),h=s(t.oldURL);if(console.log(`router hash:${h} -> ${e}`),e===h)return void(this.nextHash="");this.backed=!1,this.hash=this.hash||[];const i=this.hash;!i||0===i.length||i.length>0&&i[i.length-1]!==e?(i.length>0?console.log(`hash:${i[i.length-1]} -> ${e}`):console.log(`hash:null -> ${e}`),i.push(e)):i.length>1&&i[i.length-2]===e?(this.backed=!0,console.log(`back hash:${i[i.length-2]} <- ${e}`),i.pop()):i.length>0&&i[i.length-1]===e&&console.log(`same hash: ${e}`),this.routeTo(i[i.length-1],this.param,this.refresh),this.refresh=!1,this.param=null,this.nextHash=""},!1)}go(e,h=null,i=!1){e=e||"home",e=this.repairUrl(e),s(t.href)===e?(this.nextHash=s(e),this.hash[this.hash.length-1]!==this.nextHash&&this.hash.push(this.nextHash),this.routeTo(e,h,i)):(this.param=h,this.refresh=i,this.nextHash=e,function(s){let e=s;"!"!==s[0]&&(e=`!${s}`),t.hash=e}(e))}repairUrl(t){let s=t;try{t.startsWith("../")?s=t.replace(/\.\.\//,`/${this.opt.owner}/`):t.startsWith("/")||(s=`${t}`)}catch(t){console.log(`router repairUrl exp:${t.message}`)}return s!==t&&console.log(`router repairUrl:${t} -> ${s}`),s}back(){window.history.back()}loaded(t){return $.id(t.id)||this.ps[t.id]}load(t){let s=null;try{s=new Promise((s,e)=>{console.log(`router load path:${t}`);const h=t.lastIndexOf("/"),i=t.substr(h+1);if("local"===this.opt.mode){const t=new Promise((t,s)=>{const e=`${this.opt.local}/page/${i}.html?v=${Date.now()}`;$.get(e).then(s=>{console.log("router load html:",{url:e,rs:s});const h=new(__webpack_require__(`./src/page/${i}.js`).default)({app:this.app});h.html=s,$.router.push(h),t(h)},t=>s(t))}),h=new Promise((t,s)=>{const e=`${this.opt.local}/page/${i}.css?v=${Date.now()}`;$.get(e).then(s=>{console.log("router load css:",{url:e,rs:s}),t(s)},t=>s(t))});Promise.all([t,h]).then(t=>{t[0].css=t[1],s(t[0])}).catch(t=>e(t))}else{t=`${t.substring(1,h)}/page/${i}`;const a=`${this.opt.cos}/${t}.js?v=${this.opt.ver}`;console.log(`router load url:${a}`),$.get(a).then(t=>{console.log(t);const e=JSON.parse(t);if(e&&e.js){const t=Object.keys(e.js)[0];e.js[t],$._m.add(e.js);const h=new($._m(t).default);h.html=e.html,h.css=e.css,$.router.push(h),s(h)}},t=>e(t))}})}catch(t){console.log(`load exp:${t.message}`)}return s}addCss(t){const s=document.createElement("style");this.style&&(this.lastStyle=this.style),this.style=s,$("head").append(s),this.style.innerHTML=t}removeCss(){this.lastStyle&&this.lastStyle.parentNode&&this.lastStyle.parentNode.removeChild(this.lastStyle)}routeTo(t,s,e){let h=this.findRoute(t,s,e);h?this.to(h,e):this.load(t).then(i=>{(h=this.findRoute(t,s,e))&&this.to(h,e)})}to(t,s){if(!t)return console.error("route to null page."),this;this.lastPage=this.page,this.page=t,$.page=this.page,$.lastPage=this.lastPage,this.lasts=this.lasts||[];const e=this.lasts;this.backed=!1,e.length>1&&e[e.length-2].id===t.id?(this.backed=!0,console.log(`to back id:${e[e.length-2].id} <- ${t.id}`),e.pop()):e.length>0&&e[e.length-1].id===t.id?console.log(`to same id: ${t.id}`):(0===e.length||e.length>0&&e[e.length-1].id!==t.id)&&(e.length>0?console.log(`to id:${e[e.length-1].id} -> ${t.id}`):console.log(`to id:null -> ${t.id}`),e.push(this.page));const h=s=>{t.doReady=!1;let e=$.id(t.id);if(!e&&(!(e=this.ps[t.id])&&s&&(e=s,this.ps[t.id]=e,t.doReady=!0),e)){if(this.view){this.addCss(t.css);const s=$(e);this.backed&&this.view.hasChild()?(this.opt.className&&s.addClass(`${this.opt.className}`),this.opt.prevClass&&s.addClass(`${this.opt.prevClass}`),this.view.dom.insertBefore(e,this.view.dom.children[0])):(this.opt.className&&s.addClass(`${this.opt.className}`),this.opt.nextClass&&s.addClass(`${this.opt.nextClass}`),this.view.dom.appendChild(e))}t.doReady&&$.fastLink()}t.page=e,this.nextHash&&this.nextHash!==this.hash[this.hash.length-1]||this.switchPage(this.lastPage,t,this.backed)};if(s){let s=$.id(t.id);s&&$.remove(s),(s=this.ps[t.id])&&delete this.ps[t.id]}const i=this.loaded(t);return this.getCurrentPage(),i?h():((s,e="")=>{if(s)throw s;const i=document.createElement("div");i.id=t.id,i.innerHTML=e,h(i)})(null,t.html),this}getPath(t){const s={path:t};try{let e=t.indexOf("?");e>=0&&(s.path=t.substr(0,e),s.search=t.substr(e+1),s.search)&&(s.param={},s.search.split("&").forEach(t=>{(e=t.indexOf("="))>0&&(s.param[t.substr(0,e)]=t.substr(e+1))})),s.path.startsWith("../")&&(s.path=s.path.replace("../",`/${this.opt.owner}/`))}catch(t){console.log(`router getPath exp:${t.message}`)}return t!==s.path&&console.log(`router getPath url:${t} -> ${s.path}`),s}findRoute(t,s,e){let h=null;const i=this.getPath(t),a=this.rs.find(t=>t.path===i.path);return a&&(i.param?a.param={...i.param}:a.param={},s&&$.assign(a.param,s),a.path=i.path,a.url=t,a.lastSearch=a.search,a.search=i.search,a.refresh=e,h=a),h}push(t){try{if(!t)throw new Error("page is empty!");if(!t.path)throw new Error("page's path is empty!");return this.rs.find(s=>s.path===t.path)?void console.info(`push r.path:${t.path} exist.`):(t.id=`page-${t.path.replace(/\//g,"-")}`,t.ready=t.ready||$.noop,t.router=this,this.rs.push(t),console.debug(`router push r.path:${t.path} succ.`),this)}catch(t){alert(`router.push exp: ${t.message}`)}}aniPage(t,s,e,h){const i=`router-transition-${e||"forward"} router-transition`;s.animationEnd(()=>{console.log("animation."),this.view.removeClass(i),h&&h()}),console.log("animation..."),this.view.addClass(i)}hidePage(t,s){s&&t&&(t.hide&&t.hide(s),s.removeClass(this.opt.showClass),s.removeClass(this.opt.prevClass),s.removeClass(this.opt.nextClass),t.lastPage&&(this.ps[t.lastPage.id]=s),s.remove(),this.removeCss())}showPage(t,s){s&&(s.removeClass(this.opt.nextClass),s.removeClass(this.opt.prevClass),s.addClass(this.opt.showClass)),t&&(t.doReady&&t.ready&&$.nextTick(()=>{t.ready(s,t.param,this.backed)}),t.show&&$.nextTick(()=>{t.show(s,t.param,this.backed)}))}switchPage(t,s,e){if(!s)return;let h=this.getCurrentPage();h&&(h=$(h));let i=$.id(s.id);if(i&&(i=$(i)),h&&i&&h.dom===i.dom)return;const a=e?"backward":"forward";var o;(h||i)&&(h&&i?this.noAni?(this.noAni=!1,this.hidePage(t,h),this.showPage(s,i)):this.aniPage(h,i,a,()=>{this.hidePage(t,h),this.showPage(s,i)}):h?this.hidePage(t,h):i&&this.showPage(s,i)),o=this.page.title,document.title!==o&&(/MicroMessenger/i.test(navigator.userAgent)?setTimeout(()=>{document.title=o;const t=document.createElement("iframe");t.style.display="none",t.src="img/favicon.ico",t.onload=()=>{setTimeout(()=>{document.body.removeChild(t)},0)},document.body.appendChild(t)},0):document.title=o)}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(t=t||self).WiaRouter=s();
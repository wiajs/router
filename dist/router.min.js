/*!
  * wia router v0.1.1
  * (c) 2021 Sibyl Yu
  * @license MIT
  */
var e,t;e=this,t=function(e){"use strict";function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e}).apply(this,arguments)}var a=window.location,s="auth/getCode",o="auth/getToken",n="auth/checkToken",r=function(){function e(e){var t=this;this.opt={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.nuoya.net",api:"https://wia.pub",ver:"1.0.0",mode:"prod",transition:"f7-flip"},this._index=1,this.view=null,this.as={},this.ps={},this.vs={},this.url="",this.hash=[],this.splash=!1,this.getCurrentPage=function(){return $.qu("."+t.opt.showClass)},this.opt=$.assign({},this.opt,e),this.view=$("#"+this.opt.view),this.style=null,this.lastStyle=null,this.param={},this.page=null,this.lastPage=null,this.lastApp=null,$.view=this.view,$.router=this,this.splash=!0,this.lastHash="",this.hash=[],this.nextHash="",this.lastOwner="",this.lastName="",this.lastPath="",this.backed=!1,this.owner=this.opt.owner,this.appName=this.opt.name,this.path="";var a=new(("local"===this.opt.mode?__webpack_require__("./src/index.js"):__m__("./"+this.owner+"/"+this.name+"/src/index.js")).default)({root:this.opt.root,owner:this.opt.owner,name:this.opt.name,init:!0});this.app=a,$.app=this.app,a.load&&$.nextTick((function(){a.load()})),a.show&&$.nextTick((function(){var e=window.location.hash;e.startsWith("#")&&(e=e.substr(1)),e.startsWith("!")&&(e=e.substr(1)),e=e.indexOf("?")>-1?e.replace(/\?\S*/,""):e;var t=$.urlParam();a.show(e,t)})),window.addEventListener("hashchange",(function(e){var a=i(e.newURL),s=i(e.oldURL);console.log("router hash:"+s+" -> "+a);var o=a||"index";if(a===(o=t.repairUrl(o)))if(a!==s){t.backed=!1,t.hash=t.hash||[];var n=t.hash;!n||0===n.length||n.length>0&&n[n.length-1]!==a?(n.length>0?console.log("hash:"+n[n.length-1]+" -> "+a):console.log("hash:null -> "+a),n.push(a)):n.length>1&&n[n.length-2]===a?(t.backed=!0,console.log("back hash:"+n[n.length-2]+" <- "+a),n.pop()):n.length>0&&n[n.length-1]===a&&console.log("same hash: "+a),t.routeTo(n[n.length-1],t.param,t.refresh),t.refresh=!1,t.param=null,t.nextHash=""}else t.nextHash="";else h(o)}),!1)}var r=e.prototype;return r.go=function(e,t,s){void 0===t&&(t=null),void 0===s&&(s=!1),e=e||"index",e=this.repairUrl(e),i(a.href)===e?(this.nextHash=i(e),this.hash[this.hash.length-1]!==this.nextHash&&this.hash.push(this.nextHash),this.routeTo(e,t,s)):(this.param=t,this.refresh=s,this.nextHash=e,h(e))},r.repairUrl=function(e){var t="";if(!e)return"";try{if(t=e,"/"===e)t="/";else if("~"===e)t="/"+this.owner+"/"+this.appName+"/index";else if(e.startsWith("./")&&this.path)t="/"+this.owner+"/"+this.appName+"/"+this.path+"/"+e.substr(2);else if(e.startsWith("/")){if(e.startsWith("/")){var a=e.match(/([^/?]+)\/([^/?]+)\/?([^?]*)([\s\S]*)/);if(a){var s=a[1],o=a[2],n=a[3];s&&o&&!n&&(t="/"+s+"/"+o+"/index"+a[4])}}}else t="/"+this.owner+"/"+this.appName+"/"+e;(t=(t=t.endsWith("/")?t+"index":t).replace(/\/\?/g,"/index?"))!==e&&console.log("router repairUrl:"+e+" -> "+t)}catch(e){console.error("router repairUrl exp:"+e.message)}return t},r.back=function(e,t){void 0===t&&(t=!1),this.param=e,this.refresh=t,window.history.back()},r.loaded=function(e){return $.id(e.id)||this.vs[e.id]},r.load=function(e,t){var a=this,s=null;try{s=new Promise((function(s,o){var n=e.match(/([^/]+)\/([^/]+)\/?([^?]*)/),r=null==n?void 0:n[1],i=null==n?void 0:n[2],h=null==n?void 0:n[3];r&&i&&!h&&(h="index");var l="";if(h&&h.includes("/")){var c=h.lastIndexOf("/");l=h.substr(0,c)}if(console.log("load",{owner:r,name:i,page:h,path:l}),r&&i&&h)if("local"===a.opt.mode){var p=new Promise((function(e,s){var o=a.opt.local+"/page/"+h+".html?v="+Date.now();$.get(o).then((function(s){var o=new(__webpack_require__("./src/page/"+h+".js").default)({app:a.app});o.html=s,o.param=t,o.owner=r,o.appName=i,o.url="/"+r+"/"+i+"/"+h,o.path=l,a.cachePage(o),e(o)}),(function(e){return s(e)}))})),d=new Promise((function(e,t){var s=a.opt.local+"/page/"+h+".css?v="+Date.now();$.get(s).then((function(t){e(t)}),(function(e){return t(e)}))}));Promise.all([p,d]).then((function(e){var a=e[0];a.css=e[1],a.load&&a.load(t),s(a)})).catch((function(e){return o(e)}))}else e=a.opt.cos.includes("localhost:")?a.opt.cos+"/page/"+h+".js?v="+Date.now():a.opt.cos+"/"+r+"/"+i+"/page/"+h+".js?v="+Date.now(),$.get(e).then((function(e){if(console.log(e),e&&e.js){var o=Object.keys(e.js)[0];e.js[o],$.M.add(e.js);var n=new($.M(o).default);n.html=e.html,n.css=e.css,n.param=t,n.owner=r,n.appName=i,n.url="/"+r+"/"+i+"/"+h,n.path=l,a.cachePage(n),n.load&&n.load(t),s(n)}}),(function(e){return o(e)}));else s("")}))}catch(e){console.error("load exp:"+e.message)}return s},r.switchApp=function(e,t,a){var s=this;if(e===this.owner&&t===this.appName)return a!==this.path&&(this.path=a),Promise.resolve(!0);this.getToken(e,t).then((function(o){if(o){e&&(s.owner!==s.lastOwner&&(s.lastOwner=s.owner),s.owner=e),t&&(s.appName!==s.lastName&&(s.lastName=s.appName),s.appName=t),a&&(s.path!==s.lastPath&&(s.lastPath=s.path),s.path=a);var n=s.findApp(e,t);if(!n){var r=null;r="local"===s.opt.mode?__webpack_require__("./src/app.js"):__m__("./"+s.owner+"/"+s.name+"/src/app.js"),n=new r.default({root:s.opt.root,owner:s.opt.owner,name:s.opt.name,init:!1}),s.as[e+"."+t]=n,n.load&&$.nextTick((function(){n.load()}))}return s.lastApp=s.app,s.lastApp.hide&&$.nextTick((function(){s.lastApp.hide()})),s.app=n,n.show&&$.nextTick((function(){n.show()})),!0}return!1})).catch((function(e){return console.log("switchApp err:",e),!1}))},r.getToken=function(e,t){var a=this,s=this;return new Promise((function(n,r){var i="",h=e+"/"+t+"/token";try{var l=$.store.get(h);a.checkToken(e,t,l).then((function(r){r?($.app.token=l,n(l)):(l=$.app.token,$.app.token="",a.getCode(l).then((function(a){a?$.get(s.opt.api+"/"+e+"/"+t+"/"+o,"code="+a).then((function(e){e&&(console.log("getToken",{r:e}),200===e.code?(l=e.data.token,$.app.token=l,$.store.set(h,l),i=l):console.error("getToken error",{r:e})),n(i)})).catch(n(i)):(console.error("getToken fail! no code."),n(i))})))}))}catch(e){console.error("getToken exp:",e.message)}return i}))},r.checkToken=function(e,t,a){var s=this;return new Promise((function(o,r){var i=!1;try{a?$.get(s.opt.api+"/"+e+"/"+t+"/"+n,"token="+a).then((function(e){console.log("checkToken",{token:a,rs:e}),200===e.code&&(e.data.expire,i=e.data.res),o(i)})).catch(o(i)):o(i)}catch(e){console.error("checkToken exp:",e.message),o(i)}}))},r.getCode=function(e){var t=this;return new Promise((function(a,o){var n="";try{$.get(t.opt.api+"/"+s,"token="+e).then((function(t){console.log("getCode",{token:e,rs:t}),200===t.code?n=t.data:console.error("getCode fail.",{token:e,rs:t}),a(n)})).catch(a(n))}catch(e){console.error("getCode exp:",e.message),a(n)}}))},r.addCss=function(e){var t=document.createElement("style");this.style&&(this.lastStyle=this.style),this.style=t,$("head").append(t),this.style.innerHTML=e},r.removeCss=function(){this.lastStyle&&this.lastStyle.parentNode&&this.lastStyle.parentNode.removeChild(this.lastStyle)},r.routeTo=function(e,t,a){var s=this;console.log("routeTo ",{url:e,param:t,refresh:a});var o=this.findPage(e,t,a);o?this.to(o,a):this.load(e,t).then((function(n){(o=s.findPage(e,t,a))&&s.to(o,a)}))},r.to=function(e,t){var a=this;e?this.switchApp(e.owner,e.appName,e.path).then((function(s){if(s){a.lastPage=a.page,a.lastPage&&(a.lastPage.scrollTop=a.lastPage.el.clas("page-content").dom.scrollTop),a.page=e,$.page=a.page,$.lastPage=a.lastPage,a.lasts=a.lasts||[];var o=a.lasts;a.backed=!1,o.length>1&&o[o.length-2].id===e.id?(a.backed=!0,console.log("to back id:"+o[o.length-2].id+" <- "+a.lastPage.id),o.pop()):o.length>0&&o[o.length-1].id===e.id?console.log("to same id: "+e.id):(0===o.length||o.length>0&&o[o.length-1].id!==e.id)&&(o.length>0?console.log("to id:"+o[o.length-1].id+" -> "+e.id):console.log("to id:null -> "+e.id),o.push(a.page));var n=function(t){e.doReady=!1;var s=$.id(e.id);if(!s&&(!(s=a.vs[e.id])&&t&&(s=t,a.vs[e.id]=s,e.doReady=!0),s)){if(a.view){a.addCss(e.css);var o=$(s);a.backed&&a.view.hasChild()?(a.opt.className&&o.addClass(""+a.opt.className),a.opt.prevClass&&o.addClass(""+a.opt.prevClass),a.view.dom.insertBefore(s,a.view.dom.children[0])):(a.opt.className&&o.addClass(""+a.opt.className),a.opt.nextClass&&o.addClass(""+a.opt.nextClass),a.view.dom.appendChild(s))}e.doReady&&$.fastLink()}e.el=$(s),e.view=e.el,e.dom=e.el.dom,a.nextHash&&a.nextHash!==a.hash[a.hash.length-1]||a.switchPage(a.lastPage,e,a.backed)};if(t){var r=$.id(e.id);r&&$.remove(r),(r=a.vs[e.id])&&delete a.vs[e.id]}var i=a.loaded(e);a.getCurrentPage(),i?n():function(t,a){if(void 0===a&&(a=""),t)throw t;var s=$(a);e.view=s,e.el=s,e.dom=s.dom,s.dom.id=e.id,n(e.dom)}(null,e.html)}})).catch((function(e){return console.error("to err:",e)})):console.error("route to null page.")},r.parseUrl=function(e){var t={url:e};try{var a=e.indexOf("?");a>=0&&(t.url=e.substr(0,a),t.search=e.substr(a+1),t.search&&(t.param={},t.search.split("&").forEach((function(e){(a=e.indexOf("="))>0&&(t.param[e.substr(0,a)]=e.substr(a+1))})))),t.url=this.repairUrl(t.url);var s=e.match(/([^/]+)\/([^/]+)\/([^?]+)/);s&&(t.path=s[3]),e!==t.url&&console.log("router parseUrl url:"+e+" -> "+t.url+" path:"+t.path)}catch(e){console.error("router parseUrl exp:"+e.message)}return t},r.findPage=function(e,a,s){var o=null,n=this.parseUrl(e),r=this.ps[n.url];return r?(n.param?r.param=t({},n.param):r.param={},a&&$.assign(r.param,a),r.lastSearch=r.search,r.search=n.search,r.refresh=s,o=r):console.log("findPage not find!",{url:e}),o},r.findApp=function(e,t,a,s){var o=null,n=this.as[e+"."+t];return n?(n.param={},a&&$.assign(n.param,a),n.reload=s,o=n):console.log("findApp not find!",{owner:e,name:t}),o},r.cachePage=function(e){try{if(!e)throw new Error("page is empty!");if(!e.url)throw new Error("page's url is empty!");return e.id=""+e.url.replace(/\//g,"-"),e.id.startsWith("-")&&(e.id=e.id.substr(1)),e.ready=e.ready||$.noop,e.router=this,this.ps[e.url]=e,console.debug("router cache page.url:"+e.url+" succ."),this}catch(e){console.error("router.cachePage exp: "+e.message)}},r.aniPage=function(e,t,a,s){var o=this,n="router-transition-"+(a||"forward")+" router-transition";if($.device.ios)t.animationEnd((function(){o.view.removeClass(n),s&&s()}));else{var r=t;"backward"===a&&(r=e),r.animationEnd((function(){o.view.removeClass(n),s&&s()}))}this.view.addClass(n)},r.hidePage=function(e,t){t&&e&&(t.removeClass(this.opt.showClass),t.removeClass(this.opt.prevClass),t.removeClass(this.opt.nextClass),e.hide&&e.hide(t),e.lastPage&&(this.vs[e.lastPage.id]=t),t.remove(),this.removeCss())},r.onShow=function(e,t){var a=this;try{if(!e)return;e.doReady&&(this.pageEvent("init",e,t),e.ready&&$.nextTick((function(){e.ready(t,e.param,a.backed)}))),e.back&&this.backed&&$.nextTick((function(){e.scrollTop&&(t.clas("page-content").dom.scrollTop=e.scrollTop),e.back(t,e.param)})),e.show&&!this.backed&&$.nextTick((function(){e.show(t,e.param)}))}catch(e){console.error("onShow ",{ex:e.message})}},r.showPage=function(e,t){t&&(t.removeClass(this.opt.nextClass),t.removeClass(this.opt.prevClass),t.addClass(this.opt.showClass))},r.switchPage=function(e,t,a){var s,o=this;if(t){var n=this.getCurrentPage();n&&(n=$(n));var r=$.id(t.id);if(r&&(r=$(r)),!n||!r||n.dom!==r.dom){var i=a?"backward":"forward";(n||r)&&(n&&r?this.noAni?(this.noAni=!1,this.hidePage(e,n),this.onShow(t,r),this.showPage(t,r)):(this.onShow(t,r),this.aniPage(n,r,i,(function(){o.hidePage(e,n),o.showPage(t,r)}))):n?this.hidePage(e,n):r&&(this.onShow(t,r),this.showPage(t,r))),s=this.page.title,document.title!==s&&(document.title=s)}}},r.pageEvent=function(e,t,a){try{if(!t||!a)return;if(!a.length)return;var s="page"+(e[0].toUpperCase()+e.slice(1,e.length)),o="page:"+e.toLowerCase(),n={$el:a,el:a.dom};if("init"===e){if(a[0].f7PageInitialized)return a.trigger("page:reinit",n),void this.emit("pageReinit",n);a[0].f7PageInitialized=!0}a.trigger(o,n),this.app.emit(s,n)}catch(e){console.error("pageEvent exp:"+e.message)}},e}();function i(e){e||(e=a.href);var t=e.indexOf("#!");return-1!==t?t++:t=e.indexOf("#"),-1!==t?e.substring(t+1):""}function h(e){var t=e;"!"!==e[0]&&(t="!"+e),a.hash=t}$.go=function(e,t,a){void 0===t&&(t=null),void 0===a&&(a=!1),$.router.go(e,t,a)},$.back=function(e,t){void 0===t&&(t=!1),$.router.back(e,t)},e.Router=r,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@wiajs/Router"]={});
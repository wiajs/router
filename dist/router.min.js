/*!
  * wia dom v1.0.11
  * (c) 2015-2023 Sibyl Yu and contributors
  * Released under the MIT License.
  */
/*!
  * wia dom v1.0.11
  * (c) 2015-2023 Sibyl Yu and contributors
  * Released under the MIT License.
  */
var e,t;e=this,t=function(){"use strict";function e(){return e=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e},e.apply(this,arguments)}var t=window.location,a="auth/getCode",s="auth/getToken",i="auth/checkToken",r={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.wia.pub",api:"https://wia.pub",ver:"1.0.2",mode:"prod",transition:"f7-flip"},o=function(){function o(t){var a,s,i,o=this;this._index=1,this.view=null,this.as={},this.ps={},this.ids=[],this.vs={},this.vps=new Map,this.url="",this.hash=[],this.splash=!1,this.getCurrentPage=function(){return $.qu("."+o.opt.showClass)},this.opt=e({},r,t);var l=this.opt;this.view=$("#"+this.opt.view),this.param={},this.refresh={},this.page=null,this.pages=l.pages,l.pages&&(this.vite=!0),this.lastPage=null,this.lastApp=null,$.view=this.view,$.router=this,this.splash=!0,this.lastHash="",this.hash=[],this.nextHash="",this.lastOwner="",this.lastName="",this.lastPath="",this.backed=!1,this.owner=l.owner,this.appName=l.name,this.path="";var c=new("local"===this.opt.mode?null!=(a=null==(s=this.pages)?void 0:s["./src/index"])?a:__webpack_require__("./src/index.js").default:__m__("./"+this.owner+"/"+this.name+"/src/index.js"))({el:l.el||l.root,theme:null!=(i=l.theme)?i:"auto",owner:l.owner,name:l.name,init:!0});this.app=c,$.app=this.app,c.ready&&$.nextTick((function(){c.ready()})),c.show&&$.nextTick((function(){var e=window.location.hash;e.startsWith("#")&&(e=e.substr(1)),e.startsWith("!")&&(e=e.substr(1)),e=e.indexOf("?")>-1?e.replace(/\?\S*/,""):e;var t=$.urlParam();c.show(e,t),$.view.qus('a[href=""]').attr("href","javascript:;")})),window.addEventListener("hashchange",(function(e){var t=n(e.newURL),a=n(e.oldURL);console.log("router hash:"+a+" -> "+t);var s=t||"index";if(t===(s=o.repairUrl(s)))if(t!==a){o.backed=!1,o.hash=o.hash||[];var i=o.hash,r=i.length;o.lastHash=r>0?i[r-1]:"",r>1&&i[r-2]===t?(o.backed=!0,console.log("hash:"+t+" <- "+o.lastHash),i.pop()):o.lastHash===t?console.log("hash: -- "+t):o.lastHash!==t&&(console.log("hash:"+o.lastHash+" -> "+t),i.push(t)),s=i.slice(-1)[0],o.routeTo(s,o.param[s],o.refresh[s],o.lastHash),o.nextHash=""}else o.nextHash="";else h(s)}),!1)}var l=o.prototype;return l.go=function(e,a,s){void 0===a&&(a=null),void 0===s&&(s=!1),e=e||"index",e=this.repairUrl(e),n(t.href)===e?(this.nextHash=e,this.hash.length&&this.hash[this.hash.length-1]===this.nextHash||this.hash.push(this.nextHash),this.routeTo(e,a,s)):(this.param[e]=a,this.refresh[e]=s,this.nextHash=e,h(e))},l.repairUrl=function(e){var t="";if(!e)return"";try{if(t=e,"/"===e)t="/";else if("~"===e)t="/"+this.owner+"/"+this.appName+"/index";else if(e.startsWith("../")){var a=this.path,s=this.path.lastIndexOf("/");s>-1?(a=a.substring(0,s),a=(s=this.path.lastIndexOf("/"))>-1?a.substring(0,s):""):a="",t=""===a?"/"+this.owner+"/"+this.appName+"/"+e.substr(3):"/"+this.owner+"/"+this.appName+"/"+a+"/"+e.substr(3)}else if(e.startsWith("./")&&this.path){var i=this.path,r=this.path.lastIndexOf("/");r>-1?(i=i.substring(0,r),t="/"+this.owner+"/"+this.appName+"/"+i+"/"+e.substr(2)):t="/"+this.owner+"/"+this.appName+"/"+e.substr(2)}else if(e.startsWith("/")){if(e.startsWith("/")){var o=e.match(/([^/?]+)\/([^/?]+)\/?([^?]*)([\s\S]*)/);if(o){var n=o[1],h=o[2],l=o[3];n&&h&&!l&&(t="/"+n+"/"+h+"/index"+o[4])}}}else t="/"+this.owner+"/"+this.appName+"/"+e;(t=(t=t.endsWith("/")?t+"index":t).replace(/\/\?/g,"/index?"))!==e&&console.log("router repairUrl:"+e+" -> "+t)}catch(e){console.error("router repairUrl exp:"+e.message)}return t},l.back=function(e,t){var a;if(void 0===t&&(t=!1),(null==(a=this.hash)?void 0:a.length)>1){var s=this.hash[this.hash.length-2];this.param[s]=e,this.refresh[s]=t}window.history.back()},l.loaded=function(e){return $.id(e.id)||this.vs[e.id]},l.load=function(e,t){var a=this,s=null;try{s=new Promise((function(s,i){var r=e.match(/([^/]+)\/([^/]+)\/?([^?]*)/),o=null==r?void 0:r[1],n=null==r?void 0:r[2],h=null==r?void 0:r[3];if(o&&n&&!h&&(h="index"),console.log("load",{owner:o,name:n,path:h}),o&&n&&h)if("local"===a.opt.mode){var l=new Promise((function(e,s){var i=a.opt.local+"/page/"+h+".html?v="+Date.now();$.get(i).then((function(s){var i,r,l=new(null!=(i=null==(r=a.pages)?void 0:r["./page/"+h])?i:__webpack_require__("./src/page/"+h+".js").default)({app:a.app});l.html=a.vite?s.replace('<script type="module" src="/@vite/client"><\/script>',""):s,l.param=t,l.owner=o,l.appName=n,l.url="/"+o+"/"+n+"/"+h,l.path=h,a.cachePage(l),e(l)}),(function(e){return s(e)}))})),c=new Promise((function(e,t){var s=a.opt.local+"/page/"+h+".css?v="+Date.now();a.vite?import(a.opt.local+"/page/"+h+".css").then((function(t){return e(t)})).catch((function(e){return t(e)})):$.get(s).then((function(t){e(t)}),(function(e){return t(e)}))}));Promise.all([l,c]).then((function(e){var a=e[0];a.css=e[1],a.load&&a.load(t),s(a)})).catch((function(e){return i(e)}))}else e=a.opt.cos.includes("localhost:")?a.opt.cos+"/page/"+h+".js?v="+Date.now():a.opt.cos+"/"+o+"/"+n+"/page/"+h+".js?v="+Date.now(),$.get(e).then((function(e){if(e&&e.js){var i=Object.keys(e.js)[0];e.js[i],$.M.add(e.js);var r=new($.M(i).default);r.html=e.html,r.css=e.css,r.param=t,r.owner=o,r.appName=n,r.url="/"+o+"/"+n+"/"+h,r.path=h,a.cachePage(r),r.load&&r.load(t),s(r)}}),(function(e){return i(e)}));else s("")}))}catch(e){console.error("load exp:"+e.message)}return s},l.switchApp=function(e,t,a){var s=this;if(e===this.owner&&t===this.appName)return a!==this.path&&(this.path=a),Promise.resolve(!0);this.getToken(e,t).then((function(i){if(i){e&&(s.owner!==s.lastOwner&&(s.lastOwner=s.owner),s.owner=e),t&&(s.appName!==s.lastName&&(s.lastName=s.appName),s.appName=t),a&&(s.path!==s.lastPath&&(s.lastPath=s.path),s.path=a);var r=s.findApp(e,t);if(!r){var o,n,h=null;h="local"===s.opt.mode?null!=(o=null==(n=s.pages)?void 0:n["./src/index"])?o:__webpack_require__("./src/index.js").default:__m__("./"+s.owner+"/"+s.name+"/src/index.js"),r=new h({root:s.opt.root,owner:s.opt.owner,name:s.opt.name,init:!1}),s.as[e+"."+t]=r,s.lastPage=null,s.page=null,$.lastPage=null,$.page=null,r.ready&&$.nextTick((function(){r.ready()}))}return s.lastApp=s.app,s.lastApp.hide&&$.nextTick((function(){s.lastApp.hide()})),s.app=r,r.show&&$.nextTick((function(){r.show(),$.view.qus('a[href=""]').attr("href","javascript:;")})),!0}return!1})).catch((function(e){return console.log("switchApp err:",e),!1}))},l.getToken=function(e,t){var a=this,i=this;return new Promise((function(r,o){var n="",h=e+"/"+t+"/token";try{var l=$.store.get(h);a.checkToken(e,t,l).then((function(o){o?($.app.token=l,r(l)):(l=$.app.token,$.app.token="",a.getCode(l).then((function(a){a?$.get(i.opt.api+"/"+e+"/"+t+"/"+s,"code="+a).then((function(e){e&&(200===e.code?(l=e.data.token,$.app.token=l,$.store.set(h,l),n=l):console.error("getToken error",{r:e})),r(n)})).catch(r(n)):(console.error("getToken fail! no code."),r(n))})))}))}catch(e){console.error("getToken exp:",e.message)}return n}))},l.checkToken=function(e,t,a){var s=this;return new Promise((function(r,o){var n=!1;try{a?$.get(s.opt.api+"/"+e+"/"+t+"/"+i,"token="+a).then((function(e){200===e.code&&(e.data.expire,n=e.data.res),r(n)})).catch(r(n)):r(n)}catch(e){console.error("checkToken exp:",e.message),r(n)}}))},l.getCode=function(e){var t=this;return new Promise((function(s,i){var r="";try{$.get(t.opt.api+"/"+a,"token="+e).then((function(t){200===t.code?r=t.data:console.error("getCode fail.",{token:e,rs:t}),s(r)})).catch(s(r))}catch(e){console.error("getCode exp:",e.message),s(r)}}))},l.addCss=function(e){var t="css-"+e.id,a=$.id(t);a||((a=document.createElement("style")).id=t,a.innerHTML=e.css,$("head").append(a))},l.removeCss=function(e){var t="css-"+e.id,a=$.id(t);a&&$(a).remove()},l.routeTo=function(e,t,a,s){var i,r=this;void 0===a&&(a=!1),void 0===s&&(s=""),a=null!=(i=a)&&i,console.log("routeTo ",{url:e,param:t,refresh:a});var o=this.findPage(e,t,a);o?this.to(o,a,s):this.load(e,t).then((function(i){(o=r.findPage(e,t,a))&&r.to(o,a,s)}))},l.to=function(e,t,a){var s=this;void 0===t&&(t=!1),void 0===a&&(a=""),e?this.switchApp(e.owner,e.appName,e.path).then((function(i){if(i){var r,o,n;s.lastPage=s.page,s.lastPage&&s.lastPage.scrollTop&&(s.lastPage.scrollTop=null!=(r=null==(o=s.lastPage.view.class("page-content"))||null==(n=o.dom)?void 0:n.scrollTop)?r:0),s.page=e,$.page=s.page,$.lastPage=s.lastPage;var h=s.ids;s.backed=!1,h.length>1&&h[h.length-2]===e.id?(s.backed=!0,console.log("to back id:"+e.id+" <- "+h[h.length-1]),h.pop()):h.length>0&&h[h.length-1]===e.id?console.log("to same id: "+e.id):(0===h.length||h.length>0&&h[h.length-1]!==e.id)&&(h.length>0?console.log("to id:"+h[h.length-1]+" -> "+e.id):console.log("to id:null -> "+e.id),h.push(e.id));var l=function(t){var i,r;e.doReady=!1;var o=$.id(e.id);if(!o&&(!(o=s.vs[e.id])&&t&&(o=t,s.vs[e.id]=o,e.doReady=!0),o&&s.view)){s.vite||s.addCss(e);var n=$(o),h=n.hasClass("page-master");(s.backed||h)&&s.view.hasChild()?(s.opt.className&&n.addClass(""+s.opt.className),s.opt.prevClass&&!h&&n.addClass(""+s.opt.prevClass),s.view.dom.insertBefore(o,s.view.lastChild().dom)):(s.opt.className&&n.addClass(""+s.opt.className),s.opt.nextClass&&!h&&n.addClass(""+s.opt.nextClass),s.view.dom.appendChild(o))}e.el!==o&&(e.el=o),e.dom!==o&&(e.dom=o),(null==(i=e.$el)?void 0:i.dom)!==o&&(e.$el=$(o,!0)),(null==(r=e.view)?void 0:r.dom)!==o&&(e.view=e.$el),s.nextHash&&s.nextHash!==s.hash[s.hash.length-1]||s.switchPage(e,s.backed,a)};if(t){var c=$.id(e.id);c&&$.remove(c),(c=s.vs[e.id])&&delete s.vs[e.id]}s.loaded(e)?l():function(t,a){if(void 0===a&&(a=""),t)throw t;var i=$(a,!0);i.dom.id=e.id,e.view=i,e.$el=i,e.el=i.dom,e.dom=i.dom,s.vps.set(e.dom,e),l(e.dom)}(null,e.html)}})).catch((function(e){return console.error("to err:",e)})):console.error("route to null page.")},l.parseUrl=function(e){var t={url:e};try{var a=e.indexOf("?");a>=0&&(t.url=e.substr(0,a),t.search=e.substr(a+1),t.search&&(t.param={},t.search.split("&").forEach((function(e){(a=e.indexOf("="))>0&&(t.param[e.substr(0,a)]=e.substr(a+1))})))),t.url=this.repairUrl(t.url);var s=e.match(/([^/]+)\/([^/]+)\/([^?]+)/);s&&(t.path=s[3]),e!==t.url&&console.log("router parseUrl url:"+e+" -> "+t.url+" path:"+t.path)}catch(e){console.error("router parseUrl exp:"+e.message)}return t},l.findPage=function(t,a,s){void 0===s&&(s=!1);var i=null,r=this.parseUrl(t),o=this.ps[r.url];return o?(r.param?o.param=e({},r.param):o.param={},a&&$.assign(o.param,a),o.lastSearch=o.search,o.search=r.search,o.refresh=s,i=o):console.log("findPage not find!",{url:t}),i},l.findApp=function(e,t,a,s){var i=null,r=this.as[e+"."+t];return r?(r.param={},a&&$.assign(r.param,a),r.reload=s,i=r):console.log("findApp not find!",{owner:e,name:t}),i},l.cachePage=function(e){try{if(!e)throw new Error("page is empty!");if(!e.url)throw new Error("page's url is empty!");return e.id=""+e.url.replace(/\//g,"-"),e.id.startsWith("-")&&(e.id=e.id.substr(1)),e.ready=e.ready||$.noop,e.router=this,this.ps[e.url]=e,this}catch(e){console.error("router.cachePage exp: "+e.message)}},l.aniPage=function(e,t,a,s){var i=this,r="router-transition-"+(a||"forward")+" router-transition";if($.device.ios)t.animationEnd((function(){i.view.removeClass(r),s&&s()}));else{var o=t;"backward"===a&&(o=e),o.animationEnd((function(){i.view.removeClass(r),s&&s()}))}this.view.addClass(r)},l.hidePage=function(e,t){if(t&&e)try{t.removeClass(this.opt.showClass),t.removeClass(this.opt.prevClass),t.removeClass(this.opt.nextClass);try{e.hide&&e.hide(t)}catch(e){console.log("page hide exp!",{exp:e})}t.remove(),this.removeCss(e)}catch(e){console.error("hidePage exp:",e.message)}},l.onShow=function(e,t){var a=this;try{if(!e)return;var s=e.view;e.doReady&&e.ready&&$.nextTick((function(){try{e.ready(s,e.param,a.backed,t)}catch(e){console.log("page ready exp!",{exp:e})}a.pageEvent("init",e,s),$.fastLink()})),e.back&&this.backed&&$.nextTick((function(){try{var a,i,r;null!=(a=s.class("page-content"))&&null!=(i=a.dom)&&i.scrollTop&&(s.class("page-content").dom.scrollTop=null!=(r=e.scrollTop)?r:0),e.back(s,e.param,t)}catch(e){console.log("page back exp!",{exp:e})}})),e.show&&!this.backed&&$.nextTick((function(){try{e.show(s,e.param,t)}catch(e){console.log("page show exp!",{exp:e})}}))}catch(e){console.error("onShow ",{ex:e.message})}},l.showPage=function(e){if(e){var t=e.view;t.removeClass(this.opt.nextClass),t.removeClass(this.opt.prevClass),t.hasClass("page-master")||t.hasClass("page-master-detail")?this.view.addClass("view-master-detail"):this.view.hasClass("view-master-detail")&&this.view.removeClass("view-master-detail"),t.hasClass("page-master")||t.addClass(this.opt.showClass)}},l.switchPage=function(e,t,a){var s,i=this;if(e)try{var r=null,o=this.getCurrentPage();o&&((o=$(o)).hasClass("page-master")?o=null:r=this.vps.get(o.dom));var n=$.id(e.id);if(n&&(n=e.view).hasClass("page-master")&&(o=null),o&&n&&o.dom===n.dom)return;var h=t?"backward":"forward";if((o||n)&&(o&&n?this.noAni?(this.noAni=!1,this.hidePage(r,o),this.onShow(e,a),this.showPage(e)):(this.onShow(e,a),this.aniPage(o,n,h,(function(){i.hidePage(r,o),i.showPage(e)}))):o?this.hidePage(r,o):n&&(this.onShow(e,a),this.showPage(e))),s=this.page.title,document.title!==s&&(document.title=s),this.hash.length>0){var l,c,p=this.hash.slice(-1)[0];null!=(l=this.param)&&l[p]&&delete this.param[p],null!=(c=this.refresh)&&c[p]&&delete this.param[p]}}catch(e){console.error("switchPage exp:"+e.message)}},l.pageEvent=function(e,t,a){try{if(!t||!a)return;if(!a.length)return;var s="page"+(e[0].toUpperCase()+e.slice(1,e.length)),i="page:"+e.toLowerCase(),r={$el:a,el:a.dom};if("init"===e){if(a[0].f7PageInitialized)return a.trigger("page:reinit",r),void this.emit("pageReinit",r);a[0].f7PageInitialized=!0}a.trigger(i,r),this.app.emit("local::"+s,r)}catch(e){console.error("pageEvent exp:"+e.message)}},o}();function n(e){e||(e=t.href);var a=e.indexOf("#!");return-1!==a?a++:a=e.indexOf("#"),-1!==a?e.substring(a+1):""}function h(e){var a=e;"!"!==e[0]&&(a="!"+e),t.hash=a}return $.go=function(e,t,a){void 0===t&&(t=null),void 0===a&&(a=!1),$.router.go(e,t,a)},$.back=function(e,t){void 0===t&&(t=!1),$.router.back(e,t)},o.default=o,o},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self)["@wiajs/router"]=t();
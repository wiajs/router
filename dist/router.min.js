/*!
  * wia dom v1.0.16
  * (c) 2015-2025 Sibyl Yu
  * Released under the MIT License.
  */
var e,t;e=this,t=function(){"use strict";const e=window.$,t=window.__m__;let s=window.location;const a="auth/getCode",i="auth/getToken",o="auth/checkToken",r={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.wia.pub",api:"https://wia.pub",ver:"1.0.2",mode:"prod",transition:"f7-flip"};let h=class{constructor(t){this._index=1,this.view=null,this.apps={},this.ps={},this.ids=[],this.vs={},this.vps=new Map,this.url="",this.splash=!0,this.owner="",this.appName="",this.path="",this.lastOwner="",this.lastName="",this.lastPath="",this.param={},this.refresh={},this.page=null,this.hash=[],this.lastHash="",this.nextHash="",this.backed=!1,this.init=!0,this.getCurrentPage=()=>e.qu(`.${this.opt.showClass}`);const s=this;s.opt={...r,...t};const{opt:a}=s;s.view=e(`#${s.opt.view}`),s.pages=a.pages,a.pages&&(s.vite=!0),s.lastPage=null,s.lastApp=null,e.view=s.view,e.router=s,window.addEventListener("hashchange",(e=>{const t=n(e.newURL),a=n(e.oldURL);console.log(`router hash:${a} -> ${t}`);let i=t||"index";if(i=s.repairUrl(i),t!==i)return void l(i);if(t===a)return void(s.nextHash="");s.backed=!1,s.hash=s.hash||[];const o=s.hash,r=o.length;s.lastHash=r>0?o[r-1]:"",r>1&&o[r-2]===t?(s.backed=!0,console.log(`hash:${t} <- ${s.lastHash}`),o.pop()):s.lastHash===t?console.log(`hash: == ${t}`):s.lastHash!==t&&(console.log(`hash:${s.lastHash} -> ${t}`),o.push(t)),[i]=o.slice(-1),s.routeTo(i,this.param[i],this.refresh[i],this.lastHash),s.nextHash=""}),!1);const i=n();if(i){console.log(`router start -> ${i}`);const t=s.repairUrl(i);if(i!==t)l(t);else{s.hash.push(t);const a=e.urlParam();s.routeTo(t,a,!0),s.nextHash=""}}}go(e,t=null,a=!1){e=e||"index",e=this.repairUrl(e),n(s.href)===e?(this.nextHash=e,this.hash.length&&this.hash[this.hash.length-1]===this.nextHash||this.hash.push(this.nextHash),this.routeTo(e,t,a)):(this.param[e]=t,this.refresh[e]=a,this.nextHash=e,l(e))}repairUrl(e){let t="";const s=this;if(!e)return"";try{if(t=e,"/"===e)t="/";else if("codecamp"===e)t="/nuoya/camp/course/index";else if("~"===e)t=`/${s.owner}/${s.appName}/index`;else if(e.startsWith("../")){let{path:s}=this,a=this.path.lastIndexOf("/");a>-1?(s=s.substring(0,a),a=this.path.lastIndexOf("/"),s=a>-1?s.substring(0,a):""):s="",t=""===s?`/${this.owner}/${this.appName}/${e.substr(3)}`:`/${this.owner}/${this.appName}/${s}/${e.substr(3)}`}else if(e.startsWith("./")&&s.path){let{path:a}=s;const i=s.path.lastIndexOf("/");i>-1?(a=a.substring(0,i),t=`/${s.owner}/${s.appName}/${a}/${e.substr(2)}`):t=`/${s.owner}/${s.appName}/${e.substr(2)}`}else if(e.startsWith("/")){if(e.startsWith("/")){const s=e.match(/([^/?]+)\/([^/?]+)\/?([^?]*)([\s\S]*)/);if(s){const e=s[1],a=s[2],i=s[3];e&&a&&!i&&(t=`/${e}/${a}/index${s[4]}`)}}}else t=s.owner&&s.appName?`/${s.owner}/${s.appName}/${e}`:`/${e}`;t=t.endsWith("/")?`${t}index`:t,t=t.replace(/\/\?/g,"/index?"),t!==e&&console.log(`router repairUrl:${e} -> ${t}`)}catch(e){console.error(`router repairUrl exp:${e.message}`)}return t}back(e,t=!1){if(this.hash?.length>1){const s=this.hash[this.hash.length-2];this.param[s]=e,this.refresh[s]=t}window.history.back()}loaded(t){return e.id(t.id)||this.vs[t.id]}async load(t,s){let a;const i=this;try{const o=t.match(/([^/]+)\/([^/]+)\/?([^?]*)/),r=o?.[1],h=o?.[2];let n=o?.[3];if(r&&h&&!n&&(n="index"),console.log("load",{owner:r,name:h,path:n}),!r||!h||!n)throw new Error("need owner|name|path");if(!i.findApp(r,h))return void await i.switchApp(r,h,n);if("local"===this.opt.mode){const t=new Promise(((t,a)=>{const i=`${this.opt.local}/page/${n}.html?v=${Date.now()}`;e.get(i).then((e=>{const a=new(this.pages?.[`./page/${n}`]??__webpack_require__(`./src/page/${n}.js`).default)({app:this.app});a.html=this.vite?e.replace('<script type="module" src="/@vite/client"><\/script>',""):e,a.param=s,a.owner=r,a.appName=h,a.url=`/${r}/${h}/${n}`,a.path=n,this.cachePage(a),t(a)}),(e=>a(e)))})),i=new Promise(((t,s)=>{const a=`${this.opt.local}/page/${n}.css?v=${Date.now()}`;this.vite?import(`${this.opt.local}/page/${n}.css`).then((e=>t(e))).catch((e=>s(e))):e.get(a).then((e=>{t(e)}),(e=>t("")))})),o=await Promise.all([t,i]),l=o[0];l.css=o[1],l.load&&l.load(s),a=l}else{t=this.opt.cos.includes("localhost:")?`${this.opt.cos}/page/${n}.js?v=${Date.now()}`:`${this.opt.cos}/${r}/${h}/page/${n}.js?v=${Date.now()}`,console.log("router load page:",{url:t});const o=await e.get(t);if(o&&o.js){const t=Object.keys(o.js)[0];o.js[t],e.M.add(o.js);const l=e.M(t),p=new(new l.default)({app:i.app});p.html=o.html,p.css=o.css,p.param=s,p.owner=r,p.appName=h,p.url=`/${r}/${h}/${n}`,p.path=n,i.cachePage(p),p.load&&p.load(s),a=p}}}catch(e){console.error(`load exp:${e.message}`)}return a}async createApp(s,a){let i;const o=this,{opt:r}=o;try{let h=o.findApp(s,a);if(h)return h;let n=null;n="local"===o.opt.mode?o.pages?.["./src/index"]??__webpack_require__("./src/index.js").default:t(`./${o.owner}/${o.name}/src/index.js`),h=new n({el:r.el||r.root,init:o.init,owner:s,name:a}),h&&(o.init=!1),o.apps[`${s}.${a}`]=h,h.ready&&e.nextTick((()=>{h.ready()})),i=h}catch(e){console.log("createApp err:",e.message)}return i}showApp(t){try{if(!t?.show)return;e.nextTick((()=>{let{hash:s}=window.location;s.startsWith("#")&&(s=s.substring(1)),s.startsWith("!")&&(s=s.substring(1));const a=e.urlParam(s);s=s.indexOf("?")>-1?s.replace(/\?\S*/,""):s,t.show(s,a),e.view.qus('a[href=""]').attr("href","javascript:;")}))}catch(e){console.log("switchApp err:",e.message)}}async switchApp(t,s,a){let i=!1;const o=this;try{if(t===o.owner&&s===o.appName)return a!==o.path&&(o.path=a),!0;{t&&(o.owner!==o.lastOwner&&(o.lastOwner=o.owner),o.owner=t),s&&(o.appName!==o.lastName&&(o.lastName=o.appName),o.appName=s),a&&(o.path!==o.lastPath&&(o.lastPath=o.path),o.path=a);let r=o.findApp(t,s);r||(r=await o.createApp(t,s)),o.lastApp=o.app,o.lastApp?.hide&&e.nextTick((()=>{o.lastApp.hide()})),o.app=r,e.app=r,o.lastPage=null,o.page=null,e.lastPage=null,e.page=null,o.showApp(r),i=!0}}catch(e){console.log("switchApp err:",e.message)}return i}getToken(t,s){const a=this;return new Promise(((o,r)=>{let h="";const n=`${t}/${s}/token`;try{let r=e.store.get(n);this.checkToken(t,s,r).then((l=>{l?(e.app.token=r,o(r)):(r=e.app.token,e.app.token="",this.getCode(r).then((l=>{l?e.get(`${a.opt.api}/${t}/${s}/${i}`,`code=${l}`).then((t=>{t&&(200===t.code?(r=t.data.token,e.app.token=r,e.store.set(n,r),h=r):console.error("getToken error",{r:t})),o(h)})).catch(o(h)):(console.error("getToken fail! no code."),o(h))})))}))}catch(e){console.error("getToken exp:",e.message)}return h}))}checkToken(t,s,a){return new Promise(((i,r)=>{let h=!1;try{a?e.get(`${this.opt.api}/${t}/${s}/${o}`,`token=${a}`).then((e=>{200===e.code&&(e.data.expire,h=e.data.res),i(h)})).catch(i(h)):i(h)}catch(e){console.error("checkToken exp:",e.message),i(h)}}))}getCode(t){return new Promise(((s,i)=>{let o="";try{e.get(`${this.opt.api}/${a}`,`token=${t}`).then((e=>{200===e.code?o=e.data:console.error("getCode fail.",{token:t,rs:e}),s(o)})).catch(s(o))}catch(e){console.error("getCode exp:",e.message),s(o)}}))}addCss(t){if(t.css){const s=`css-${t.id}`;let a=e.id(s);a||(a=document.createElement("style"),a.id=s,a.innerHTML=t.css,e("head").append(a))}}removeCss(t){const s=`css-${t.id}`,a=e.id(s);a&&e(a).remove()}routeTo(e,t,s=!1,a=""){s=s??!1,console.log("routeTo ",{url:e,param:t,refresh:s});let i=this.findPage(e,t,s);i?this.to(i,s,a):this.load(e,t).then((o=>{i=this.findPage(e,t,s),i&&this.to(i,s,a)}))}to(t,s=!1,a=""){t?this.switchApp(t.owner,t.appName,t.path).then((i=>{if(i){this.lastPage=this.page,this.lastPage&&this.lastPage.scrollTop&&(this.lastPage.scrollTop=this.lastPage.view.class("page-content")?.dom?.scrollTop??0),this.page=t,e.page=this.page,e.lastPage=this.lastPage;const{ids:i}=this;this.backed=!1,i.length>1&&i[i.length-2]===t.id?(this.backed=!0,console.log(`to back id:${t.id} <- ${i[i.length-1]}`),i.pop()):i.length>0&&i[i.length-1]===t.id?t.change&&t.search!==t.lastSearch?(console.log(`search ${t.lastSearch} -> ${t.search}`),e.nextTick((()=>{try{t.change(t.view,t.search,t.lastSearch)}catch(e){console.log("page change exp!",{exp:e})}}))):console.log(`to same id: ${t.id}`):(0===i.length||i.length>0&&i[i.length-1]!==t.id)&&(i.length>0?console.log(`to id:${i[i.length-1]} -> ${t.id}`):console.log(`to id:null -> ${t.id}`),i.push(t.id));const o=s=>{t.doReady=!1;let i=e.id(t.id);if(!i&&(i=this.vs[t.id],!i&&s&&(i=s,this.vs[t.id]=i,t.doReady=!0),i&&this.view)){this.vite||this.addCss(t);const s=e(i),a=s.hasClass("page-master");(this.backed||a)&&this.view.hasChild()?(this.opt.className&&s.addClass(`${this.opt.className}`),this.opt.prevClass&&!a&&s.addClass(`${this.opt.prevClass}`),this.view.dom.insertBefore(i,this.view.lastChild().dom)):(this.opt.className&&s.addClass(`${this.opt.className}`),this.opt.nextClass&&!a&&s.addClass(`${this.opt.nextClass}`),this.view.dom.appendChild(i))}t.el!==i&&(t.el=i),t.dom!==i&&(t.dom=i),t.$el?.dom!==i&&(t.$el=e(i,!0)),t.view?.dom!==i&&(t.view=t.$el),this.nextHash&&this.nextHash!==this.hash[this.hash.length-1]||this.switchPage(t,this.backed,a)};if(s){let s=e.id(t.id);s&&e.remove(s),s=this.vs[t.id],s&&delete this.vs[t.id]}const r=(s,a="")=>{if(s)throw s;const i=e(a,!0);i.dom.id=t.id,t.view=i,t.$el=i,t.el=i.dom,t.dom=i.dom,this.vps.set(t.dom,t),o(t.dom)};this.loaded(t)?o():r(null,t.html)}})).catch((e=>console.error("to err:",e))):console.error("route to null page.")}parseUrl(e){const t={url:e};try{let s=e.indexOf("?");s>=0&&(t.url=e.substr(0,s),t.search=e.substr(s+1),t.search)&&(t.param={},t.search.split("&").forEach((e=>{s=e.indexOf("="),s>0&&(t.param[e.substr(0,s)]=e.substr(s+1))}))),t.url=this.repairUrl(t.url);const a=e.match(/([^/]+)\/([^/]+)\/([^?]+)/);a&&(t.path=a[3]),e!==t.url&&console.log(`router parseUrl url:${e} -> ${t.url} path:${t.path}`)}catch(e){console.error(`router parseUrl exp:${e.message}`)}return t}findPage(t,s,a=!1){let i=null;const o=this.parseUrl(t),r=this.ps[o.url];return r?(o.param?r.param={...o.param}:r.param={},s&&e.assign(r.param,s),r.lastSearch=r.search,r.search=o.search,r.refresh=a,i=r):console.log("findPage not find!",{url:t}),i}findApp(t,s,a,i=!1){let o=null;const r=this.apps[`${t}.${s}`];return r?(r.param={},a&&e.assign(r.param,a),r.reload=i,o=r):console.log("findApp not find!",{owner:t,name:s}),o}cachePage(t){try{if(!t)throw new Error("page is empty!");if(!t.url)throw new Error("page's url is empty!");return t.id=`${t.url.replace(/\//g,"-")}`,t.id.startsWith("-")&&(t.id=t.id.substr(1)),t.ready=t.ready||e.noop,t.router=this,this.ps[t.url]=t,this}catch(e){console.error(`router.cachePage exp: ${e.message}`)}}aniPage(t,s,a,i){const o=`router-transition-${a||"forward"} router-transition`;if(e.device.ios)s.animationEnd((()=>{this.view.removeClass(o),i&&i()}));else{let e=s;"backward"===a&&(e=t),e.animationEnd((()=>{this.view.removeClass(o),i&&i()}))}this.view.addClass(o)}hidePage(e,t){if(t&&e)try{t.removeClass(this.opt.showClass),t.removeClass(this.opt.prevClass),t.removeClass(this.opt.nextClass);try{e.hide&&e.hide(t)}catch(e){console.log("page hide exp!",{exp:e})}t.remove(),this.removeCss(e)}catch(e){console.error("hidePage exp:",e.message)}}onShow(t,s){try{if(!t)return;const a=t.view;t.doReady&&t.ready&&e.nextTick((()=>{try{t.ready(a,t.param,this.backed,s)}catch(e){console.log("page ready exp!",{exp:e})}this.pageEvent("init",t,a),e.fastLink()})),t.back&&this.backed&&e.nextTick((()=>{try{a.class("page-content")?.dom?.scrollTop&&(a.class("page-content").dom.scrollTop=t.scrollTop??0),t.back(a,t.param,s)}catch(e){console.log("page back exp!",{exp:e})}})),t.show&&!this.backed&&e.nextTick((()=>{try{t.show(a,t.param,s)}catch(e){console.log("page show exp!",{exp:e})}}))}catch(e){console.error("onShow ",{ex:e.message})}}showPage(e){if(e){const t=e.view;t.removeClass(this.opt.nextClass),t.removeClass(this.opt.prevClass),t.hasClass("page-master")||t.hasClass("page-master-detail")?this.view.addClass("view-master-detail"):this.view.hasClass("view-master-detail")&&this.view.removeClass("view-master-detail"),t.hasClass("page-master")||t.addClass(this.opt.showClass)}}switchPage(t,s,a){if(t)try{let o=null,r=this.getCurrentPage();r&&(r=e(r),r.hasClass("page-master")?r=null:o=this.vps.get(r.dom));let h=e.id(t.id);if(h&&(h=t.view,h.hasClass("page-master")&&(r=null)),r&&h&&r.dom===h.dom)return;const n=s?"backward":"forward";if((r||h)&&(r&&h?this.noAni?(this.noAni=!1,this.hidePage(o,r),this.onShow(t,a),this.showPage(t)):(this.onShow(t,a),this.aniPage(r,h,n,(()=>{this.hidePage(o,r),this.showPage(t)}))):r?this.hidePage(o,r):h&&(this.onShow(t,a),this.showPage(t))),i=this.page.title,document.title!==i&&(document.title=i),this.hash.length>0){const[e]=this.hash.slice(-1);this.param?.[e]&&delete this.param[e],this.refresh?.[e]&&delete this.param[e]}}catch(e){console.error(`switchPage exp:${e.message}`)}var i}pageEvent(e,t,s){try{if(!t||!s)return;const a=this;if(!s.length)return;const i=`page${e[0].toUpperCase()+e.slice(1,e.length)}`,o=`page:${e.toLowerCase()}`,r={$el:s,el:s.dom};if("init"===e){if(s[0].f7PageInitialized)return s.trigger("page:reinit",r),void a.app.emit("pageReinit",r);s[0].f7PageInitialized=!0,s.trigger(o,r),a.app.emit(`local::${i}`,r)}}catch(e){console.error(`pageEvent exp:${e.message}`)}}};function n(e){e||(e=s.href);let t=e.indexOf("#!");return-1!==t?t++:t=e.indexOf("#"),-1!==t?e.substring(t+1):""}function l(e){let t=e;s.hash=t}return e.go=(t,s=null,a=!1)=>{e.router.go(t,s,a)},e.back=(t,s=!1)=>{e.router.back(t,s)},h.default=h,h},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self)["@wiajs/router"]=t();
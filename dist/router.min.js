/*!
  * wia router v0.1.6
  * (c) 2020 Sibyl Yu
  * @license MIT
  */
var t,e;t=this,e=function(t){"use strict";function e(){return(e=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(t[a]=s[a])}return t}).apply(this,arguments)}var s=window.location,a=function(){function t(t){var e=this;this.opt={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.nuoya.net",ver:"1.0.0",mode:"prod",transition:"f7-flip"},this._index=1,this.view=null,this.rs=[],this.ps={},this.url="",this.path=[],this.hash=[],this.splash=!1,this.getCurrentPage=function(){return $.qu("."+e.opt.showClass)},this.opt=$.assign({},this.opt,t),this.app=this.opt.app,this.app.router=this,this.view=$("#"+this.opt.view),this.style=null,this.lastStyle=null,this.param={},this.page=null,this.lastPage=null,$.view=this.view,$.router=this,this.splash=!0,this.path=[],this.lastHash="",this.hash=[],this.nextHash="",this.backed=!1,window.addEventListener("hashchange",(function(t){var s=o(t.newURL),a=o(t.oldURL);if(console.log("router hash:"+a+" -> "+s),s!==a){e.backed=!1,e.hash=e.hash||[];var i=e.hash;!i||0===i.length||i.length>0&&i[i.length-1]!==s?(i.length>0?console.log("hash:"+i[i.length-1]+" -> "+s):console.log("hash:null -> "+s),i.push(s)):i.length>1&&i[i.length-2]===s?(e.backed=!0,console.log("back hash:"+i[i.length-2]+" <- "+s),i.pop()):i.length>0&&i[i.length-1]===s&&console.log("same hash: "+s),e.routeTo(i[i.length-1],e.param,e.refresh),e.refresh=!1,e.param=null,e.nextHash=""}else e.nextHash=""}),!1)}var a=t.prototype;return a.go=function(t,e,a){void 0===e&&(e=null),void 0===a&&(a=!1),t=t||"home",t=this.repairUrl(t),o(s.href)===t?(this.nextHash=o(t),this.hash[this.hash.length-1]!==this.nextHash&&this.hash.push(this.nextHash),this.routeTo(t,e,a)):(this.param=e,this.refresh=a,this.nextHash=t,function(t){var e=t;"!"!==t[0]&&(e="!"+t),s.hash=e}(t))},a.repairUrl=function(t){var e=t;try{t.startsWith("../")?e=t.replace(/\.\.\//,"/"+this.opt.owner+"/"):t.startsWith("/")||(e=""+t)}catch(t){console.log("router repairUrl exp:"+t.message)}return e!==t&&console.log("router repairUrl:"+t+" -> "+e),e},a.back=function(){window.history.back()},a.loaded=function(t){return $.id(t.id)||this.ps[t.id]},a.load=function(t,e){var s=this,a=null;try{a=new Promise((function(a,o){console.log("router load path:"+t);var i=t.lastIndexOf("/"),n=t.substr(i+1);if("local"===s.opt.mode){var r=new Promise((function(t,e){var a=s.opt.local+"/page/"+n+".html?v="+Date.now();$.get(a).then((function(e){console.log("router load html:",{url:a,rs:e});var o=new(__webpack_require__("./src/page/"+n+".js").default)({app:s.app});o.html=e,$.router.push(o),t(o)}),(function(t){return e(t)}))})),h=new Promise((function(t,e){var a=s.opt.local+"/page/"+n+".css?v="+Date.now();$.get(a).then((function(e){console.log("router load css:",{url:a,rs:e}),t(e)}),(function(t){return e(t)}))}));Promise.all([r,h]).then((function(t){var s=t[0];s.css=t[1],s.load&&s.load(e),a(s)})).catch((function(t){return o(t)}))}else{t=t.substring(1,i)+"/page/"+n;var l=s.opt.cos+"/"+t+".js?v="+s.opt.ver;console.log("router load url:"+l),$.get(l).then((function(t){console.log(t);var s=JSON.parse(t);if(s&&s.js){var o=Object.keys(s.js)[0];s.js[o],$._m.add(s.js);var i=new($._m(o).default);i.html=s.html,i.css=s.css,$.router.push(i),i.load&&i.load(e),a(i)}}),(function(t){return o(t)}))}}))}catch(t){console.log("load exp:"+t.message)}return a},a.addCss=function(t){var e=document.createElement("style");this.style&&(this.lastStyle=this.style),this.style=e,$("head").append(e),this.style.innerHTML=t},a.removeCss=function(){this.lastStyle&&this.lastStyle.parentNode&&this.lastStyle.parentNode.removeChild(this.lastStyle)},a.routeTo=function(t,e,s){var a=this,o=this.findRoute(t,e,s);o?this.to(o,s):this.load(t,e).then((function(i){(o=a.findRoute(t,e,s))&&a.to(o,s)}))},a.to=function(t,e){var s=this;if(!t)return console.error("route to null page."),this;this.lastPage=this.page,this.page=t,$.page=this.page,$.lastPage=this.lastPage,this.lasts=this.lasts||[];var a=this.lasts;this.backed=!1,a.length>1&&a[a.length-2].id===t.id?(this.backed=!0,console.log("to back id:"+a[a.length-2].id+" <- "+t.id),a.pop()):a.length>0&&a[a.length-1].id===t.id?console.log("to same id: "+t.id):(0===a.length||a.length>0&&a[a.length-1].id!==t.id)&&(a.length>0?console.log("to id:"+a[a.length-1].id+" -> "+t.id):console.log("to id:null -> "+t.id),a.push(this.page));var o=function(e){t.doReady=!1;var a=$.id(t.id);if(!a&&(!(a=s.ps[t.id])&&e&&(a=e,s.ps[t.id]=a,t.doReady=!0),a)){if(s.view){s.addCss(t.css);var o=$(a);s.backed&&s.view.hasChild()?(s.opt.className&&o.addClass(""+s.opt.className),s.opt.prevClass&&o.addClass(""+s.opt.prevClass),s.view.dom.insertBefore(a,s.view.dom.children[0])):(s.opt.className&&o.addClass(""+s.opt.className),s.opt.nextClass&&o.addClass(""+s.opt.nextClass),s.view.dom.appendChild(a))}t.doReady&&$.fastLink()}t.page=a,s.nextHash&&s.nextHash!==s.hash[s.hash.length-1]||s.switchPage(s.lastPage,t,s.backed)};if(e){var i=$.id(t.id);i&&$.remove(i),(i=this.ps[t.id])&&delete this.ps[t.id]}var n=this.loaded(t);return this.getCurrentPage(),n?o():function(e,s){if(void 0===s&&(s=""),e)throw e;var a=document.createElement("div");a.innerHTML=s,(a=$(a).firstChild()).id=t.id,o(a)}(null,t.html),this},a.getPath=function(t){var e={path:t};try{var s=t.indexOf("?");s>=0&&(e.path=t.substr(0,s),e.search=t.substr(s+1),e.search&&(e.param={},e.search.split("&").forEach((function(t){(s=t.indexOf("="))>0&&(e.param[t.substr(0,s)]=t.substr(s+1))})))),e.path.startsWith("../")&&(e.path=e.path.replace("../","/"+this.opt.owner+"/"))}catch(t){console.log("router getPath exp:"+t.message)}return t!==e.path&&console.log("router getPath url:"+t+" -> "+e.path),e},a.findRoute=function(t,s,a){var o=null,i=this.getPath(t),n=this.rs.find((function(t){return t.path===i.path}));return n&&(i.param?n.param=e({},i.param):n.param={},s&&$.assign(n.param,s),n.path=i.path,n.url=t,n.lastSearch=n.search,n.search=i.search,n.refresh=a,o=n),o},a.push=function(t){try{if(!t)throw new Error("page is empty!");if(!t.path)throw new Error("page's path is empty!");return this.rs.find((function(e){return e.path===t.path}))?void console.info("push r.path:"+t.path+" exist."):(t.id="page-"+t.path.replace(/\//g,"-"),t.ready=t.ready||$.noop,t.router=this,this.rs.push(t),console.debug("router push r.path:"+t.path+" succ."),this)}catch(t){alert("router.push exp: "+t.message)}},a.aniPage=function(t,e,s,a){var o=this,i="router-transition-"+(s||"forward")+" router-transition";e.animationEnd((function(){console.log("animation."),o.view.removeClass(i),a&&a()})),console.log("animation..."),this.view.addClass(i)},a.hidePage=function(t,e){e&&t&&(e.removeClass(this.opt.showClass),e.removeClass(this.opt.prevClass),e.removeClass(this.opt.nextClass),t.hide&&t.hide(e),t.lastPage&&(this.ps[t.lastPage.id]=e),e.remove(),this.removeCss())},a.onShow=function(t,e){var s=this;t&&(t.doReady&&t.ready&&$.nextTick((function(){t.ready(e,t.param,s.backed)})),t.show&&$.nextTick((function(){t.show(e,t.param,s.backed)})))},a.showPage=function(t,e){e&&(e.removeClass(this.opt.nextClass),e.removeClass(this.opt.prevClass),e.addClass(this.opt.showClass))},a.switchPage=function(t,e,s){var a,o=this;if(e){var i=this.getCurrentPage();i&&(i=$(i));var n=$.id(e.id);if(n&&(n=$(n)),!i||!n||i.dom!==n.dom){var r=s?"backward":"forward";(i||n)&&(i&&n?this.noAni?(this.noAni=!1,this.hidePage(t,i),this.onShow(e,n),this.showPage(e,n)):(this.onShow(e,n),this.aniPage(i,n,r,(function(){o.hidePage(t,i),o.showPage(e,n)}))):i?this.hidePage(t,i):n&&(this.onShow(e,n),this.showPage(e,n))),a=this.page.title,document.title!==a&&(/MicroMessenger/i.test(navigator.userAgent)?setTimeout((function(){document.title=a;var t=document.createElement("iframe");t.style.display="none",t.src="img/favicon.ico",t.onload=function(){setTimeout((function(){document.body.removeChild(t)}),0)},document.body.appendChild(t)}),0):document.title=a)}}},t}();function o(t){if(!t)return"";var e=t.indexOf("#!");return-1!==e?e++:e=t.indexOf("#"),-1!==e?t.substring(e+1):""}$.go=function(t,e,s){void 0===e&&(e=null),void 0===s&&(s=!1),$.router.go(t,e,s)},$.back=function(t){void 0===t&&(t=!1),$.router.refresh=t,$.router.back()},t.Router=a,Object.defineProperty(t,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self)["@wiajs/Router"]={});
/*!
  * wia router v0.1.1
  * (c) 2021 Sibyl Yu
  * @license MIT
  */
var e,t;e=this,t=function(e){"use strict";function t(){return(t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e}).apply(this,arguments)}var a=window.location,s="auth/getCode",o="auth/getToken",i="auth/checkToken",n=function(){function e(e){var t=this;this.opt={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.nuoya.net",api:"https://wia.pub",ver:"1.0.0",mode:"prod",transition:"f7-flip"},this._index=1,this.view=null,this.as={},this.ps={},this.ids=[],this.vs={},this.vps=new Map,this.url="",this.hash=[],this.splash=!1,this.getCurrentPage=function(){return $.qu("."+t.opt.showClass)},this.opt=$.assign({},this.opt,e),this.view=$("#"+this.opt.view),this.style=null,this.lastStyle=null,this.param={},this.page=null,this.lastPage=null,this.lastApp=null,$.view=this.view,$.router=this,this.splash=!0,this.lastHash="",this.hash=[],this.nextHash="",this.lastOwner="",this.lastName="",this.lastPath="",this.backed=!1,this.owner=this.opt.owner,this.appName=this.opt.name,this.path="";var a=new(("local"===this.opt.mode?__webpack_require__("./src/index.js"):__m__("./"+this.owner+"/"+this.name+"/src/index.js")).default)({root:this.opt.root,owner:this.opt.owner,name:this.opt.name,init:!0});this.app=a,$.app=this.app,a.ready&&$.nextTick((function(){a.ready()})),a.show&&$.nextTick((function(){var e=window.location.hash;e.startsWith("#")&&(e=e.substr(1)),e.startsWith("!")&&(e=e.substr(1)),e=e.indexOf("?")>-1?e.replace(/\?\S*/,""):e;var t=$.urlParam();a.show(e,t),$.view.qus('a[href=""]').attr("href","javascript:;")})),window.addEventListener("hashchange",(function(e){var a=r(e.newURL),s=r(e.oldURL);console.log("router hash:"+s+" -> "+a);var o=a||"index";if(a===(o=t.repairUrl(o)))if(a!==s){t.backed=!1,t.hash=t.hash||[];var i=t.hash;!i||0===i.length||i.length>0&&i[i.length-1]!==a?(i.length>0?console.log("hash:"+i[i.length-1]+" -> "+a):console.log("hash:null -> "+a),i.push(a)):i.length>1&&i[i.length-2]===a?(t.backed=!0,console.log("back hash:"+i[i.length-2]+" <- "+a),i.pop()):i.length>0&&i[i.length-1]===a&&console.log("same hash: "+a),t.routeTo(i[i.length-1],t.param,t.refresh),t.refresh=!1,t.param=null,t.nextHash=""}else t.nextHash="";else l(o)}),!1)}var n=e.prototype;return n.go=function(e,t,s){void 0===t&&(t=null),void 0===s&&(s=!1),e=e||"index",e=this.repairUrl(e),r(a.href)===e?(this.nextHash=r(e),this.hash[this.hash.length-1]!==this.nextHash&&this.hash.push(this.nextHash),this.routeTo(e,t,s)):(this.param=t,this.refresh=s,this.nextHash=e,l(e))},n.repairUrl=function(e){var t="";if(!e)return"";try{if(t=e,"/"===e)t="/";else if("~"===e)t="/"+this.owner+"/"+this.appName+"/index";else if(e.startsWith("./")&&this.path)t="/"+this.owner+"/"+this.appName+"/"+this.path+"/"+e.substr(2);else if(e.startsWith("/")){if(e.startsWith("/")){var a=e.match(/([^/?]+)\/([^/?]+)\/?([^?]*)([\s\S]*)/);if(a){var s=a[1],o=a[2],i=a[3];s&&o&&!i&&(t="/"+s+"/"+o+"/index"+a[4])}}}else t="/"+this.owner+"/"+this.appName+"/"+e;(t=(t=t.endsWith("/")?t+"index":t).replace(/\/\?/g,"/index?"))!==e&&console.log("router repairUrl:"+e+" -> "+t)}catch(e){console.error("router repairUrl exp:"+e.message)}return t},n.back=function(e,t){void 0===t&&(t=!1),this.param=e,this.refresh=t,window.history.back()},n.loaded=function(e){return $.id(e.id)||this.vs[e.id]},n.load=function(e,t){var a=this,s=null;try{s=new Promise((function(s,o){var i=e.match(/([^/]+)\/([^/]+)\/?([^?]*)/),n=null==i?void 0:i[1],r=null==i?void 0:i[2],l=null==i?void 0:i[3];n&&r&&!l&&(l="index");var h="";if(l&&l.includes("/")){var p=l.lastIndexOf("/");h=l.substr(0,p)}if(console.log("load",{owner:n,name:r,page:l,path:h}),n&&r&&l)if("local"===a.opt.mode){var c=new Promise((function(e,s){var o=a.opt.local+"/page/"+l+".html?v="+Date.now();$.get(o).then((function(s){var o=new(__webpack_require__("./src/page/"+l+".js").default)({app:a.app});o.html=s,o.param=t,o.owner=n,o.appName=r,o.url="/"+n+"/"+r+"/"+l,o.path=h,a.cachePage(o),e(o)}),(function(e){return s(e)}))})),d=new Promise((function(e,t){var s=a.opt.local+"/page/"+l+".css?v="+Date.now();$.get(s).then((function(t){e(t)}),(function(e){return t(e)}))}));Promise.all([c,d]).then((function(e){var a=e[0];a.css=e[1],a.load&&a.load(t),s(a)})).catch((function(e){return o(e)}))}else e=a.opt.cos.includes("localhost:")?a.opt.cos+"/page/"+l+".js?v="+Date.now():a.opt.cos+"/"+n+"/"+r+"/page/"+l+".js?v="+Date.now(),$.get(e).then((function(e){if(e&&e.js){var o=Object.keys(e.js)[0];e.js[o],$.M.add(e.js);var i=new($.M(o).default);i.html=e.html,i.css=e.css,i.param=t,i.owner=n,i.appName=r,i.url="/"+n+"/"+r+"/"+l,i.path=h,a.cachePage(i),i.load&&i.load(t),s(i)}}),(function(e){return o(e)}));else s("")}))}catch(e){console.error("load exp:"+e.message)}return s},n.switchApp=function(e,t,a){var s=this;if(e===this.owner&&t===this.appName)return a!==this.path&&(this.path=a),Promise.resolve(!0);this.getToken(e,t).then((function(o){if(o){e&&(s.owner!==s.lastOwner&&(s.lastOwner=s.owner),s.owner=e),t&&(s.appName!==s.lastName&&(s.lastName=s.appName),s.appName=t),a&&(s.path!==s.lastPath&&(s.lastPath=s.path),s.path=a);var i=s.findApp(e,t);if(!i){var n=null;n="local"===s.opt.mode?__webpack_require__("./src/index.js"):__m__("./"+s.owner+"/"+s.name+"/src/index.js"),i=new n.default({root:s.opt.root,owner:s.opt.owner,name:s.opt.name,init:!1}),s.as[e+"."+t]=i,s.lastPage=null,s.page=null,$.lastPage=null,$.page=null,i.ready&&$.nextTick((function(){i.ready()}))}return s.lastApp=s.app,s.lastApp.hide&&$.nextTick((function(){s.lastApp.hide()})),s.app=i,i.show&&$.nextTick((function(){i.show(),$.view.qus('a[href=""]').attr("href","javascript:;")})),!0}return!1})).catch((function(e){return console.log("switchApp err:",e),!1}))},n.getToken=function(e,t){var a=this,s=this;return new Promise((function(i,n){var r="",l=e+"/"+t+"/token";try{var h=$.store.get(l);a.checkToken(e,t,h).then((function(n){n?($.app.token=h,i(h)):(h=$.app.token,$.app.token="",a.getCode(h).then((function(a){a?$.get(s.opt.api+"/"+e+"/"+t+"/"+o,"code="+a).then((function(e){e&&(200===e.code?(h=e.data.token,$.app.token=h,$.store.set(l,h),r=h):console.error("getToken error",{r:e})),i(r)})).catch(i(r)):(console.error("getToken fail! no code."),i(r))})))}))}catch(e){console.error("getToken exp:",e.message)}return r}))},n.checkToken=function(e,t,a){var s=this;return new Promise((function(o,n){var r=!1;try{a?$.get(s.opt.api+"/"+e+"/"+t+"/"+i,"token="+a).then((function(e){200===e.code&&(e.data.expire,r=e.data.res),o(r)})).catch(o(r)):o(r)}catch(e){console.error("checkToken exp:",e.message),o(r)}}))},n.getCode=function(e){var t=this;return new Promise((function(a,o){var i="";try{$.get(t.opt.api+"/"+s,"token="+e).then((function(t){200===t.code?i=t.data:console.error("getCode fail.",{token:e,rs:t}),a(i)})).catch(a(i))}catch(e){console.error("getCode exp:",e.message),a(i)}}))},n.addCss=function(e){var t=document.createElement("style");this.style&&(this.lastStyle=this.style),this.style=t,$("head").append(t),this.style.innerHTML=e},n.removeCss=function(){this.lastStyle&&this.lastStyle.parentNode&&this.lastStyle.parentNode.removeChild(this.lastStyle)},n.routeTo=function(e,t,a){var s=this;console.log("routeTo ",{url:e,param:t,refresh:a});var o=this.findPage(e,t,a);o?this.to(o,a):this.load(e,t).then((function(i){(o=s.findPage(e,t,a))&&s.to(o,a)}))},n.to=function(e,t){var a=this;e?this.switchApp(e.owner,e.appName,e.path).then((function(s){if(s){var o,i,n;a.lastPage=a.page,a.lastPage&&a.lastPage.scrollTop&&(a.lastPage.scrollTop=null!==(o=null===(i=a.lastPage.view.clas("page-content"))||void 0===i||null===(n=i.dom)||void 0===n?void 0:n.scrollTop)&&void 0!==o?o:0),a.page=e,$.page=a.page,$.lastPage=a.lastPage;var r=a.ids;a.backed=!1,r.length>1&&r[r.length-2]===e.id?(a.backed=!0,console.log("to back id:"+e.id+" <- "+r[r.length-1]),r.pop()):r.length>0&&r[r.length-1]===e.id?console.log("to same id: "+e.id):(0===r.length||r.length>0&&r[r.length-1]!==e.id)&&(r.length>0?console.log("to id:"+r[r.length-1]+" -> "+e.id):console.log("to id:null -> "+e.id),r.push(e.id));var l=function(t){e.doReady=!1;var s=$.id(e.id);if(!s&&(!(s=a.vs[e.id])&&t&&(s=t,a.vs[e.id]=s,e.doReady=!0),s)){if(a.view){a.addCss(e.css);var o=$(s),i=o.hasClass("page-master");(a.backed||i)&&a.view.hasChild()?(a.opt.className&&o.addClass(""+a.opt.className),a.opt.prevClass&&!i&&o.addClass(""+a.opt.prevClass),a.view.dom.insertBefore(s,a.view.lastChild().dom)):(a.opt.className&&o.addClass(""+a.opt.className),a.opt.nextClass&&!i&&o.addClass(""+a.opt.nextClass),a.view.dom.appendChild(s))}e.doReady&&$.fastLink()}e.el!==s&&(e.el=s),e.dom!==s&&(e.dom=s),e.$el.dom!==s&&(e.$el=$(s)),e.view.dom!==s&&(e.view=e.$el),a.nextHash&&a.nextHash!==a.hash[a.hash.length-1]||a.switchPage(e,a.backed)};if(t){var h=$.id(e.id);h&&$.remove(h),(h=a.vs[e.id])&&delete a.vs[e.id]}var p=a.loaded(e);a.getCurrentPage(),p?l():function(t,s){if(void 0===s&&(s=""),t)throw t;var o=$(s);o.dom.id=e.id,e.view=o,e.$el=o,e.el=o.dom,e.dom=o.dom,a.vps.set(e.dom,e),l(e.dom)}(null,e.html)}})).catch((function(e){return console.error("to err:",e)})):console.error("route to null page.")},n.parseUrl=function(e){var t={url:e};try{var a=e.indexOf("?");a>=0&&(t.url=e.substr(0,a),t.search=e.substr(a+1),t.search&&(t.param={},t.search.split("&").forEach((function(e){(a=e.indexOf("="))>0&&(t.param[e.substr(0,a)]=e.substr(a+1))})))),t.url=this.repairUrl(t.url);var s=e.match(/([^/]+)\/([^/]+)\/([^?]+)/);s&&(t.path=s[3]),e!==t.url&&console.log("router parseUrl url:"+e+" -> "+t.url+" path:"+t.path)}catch(e){console.error("router parseUrl exp:"+e.message)}return t},n.findPage=function(e,a,s){var o=null,i=this.parseUrl(e),n=this.ps[i.url];return n?(i.param?n.param=t({},i.param):n.param={},a&&$.assign(n.param,a),n.lastSearch=n.search,n.search=i.search,n.refresh=s,o=n):console.log("findPage not find!",{url:e}),o},n.findApp=function(e,t,a,s){var o=null,i=this.as[e+"."+t];return i?(i.param={},a&&$.assign(i.param,a),i.reload=s,o=i):console.log("findApp not find!",{owner:e,name:t}),o},n.cachePage=function(e){try{if(!e)throw new Error("page is empty!");if(!e.url)throw new Error("page's url is empty!");return e.id=""+e.url.replace(/\//g,"-"),e.id.startsWith("-")&&(e.id=e.id.substr(1)),e.ready=e.ready||$.noop,e.router=this,this.ps[e.url]=e,this}catch(e){console.error("router.cachePage exp: "+e.message)}},n.aniPage=function(e,t,a,s){var o=this,i="router-transition-"+(a||"forward")+" router-transition";if($.device.ios)t.animationEnd((function(){o.view.removeClass(i),s&&s()}));else{var n=t;"backward"===a&&(n=e),n.animationEnd((function(){o.view.removeClass(i),s&&s()}))}this.view.addClass(i)},n.hidePage=function(e,t){if(t&&e)try{t.removeClass(this.opt.showClass),t.removeClass(this.opt.prevClass),t.removeClass(this.opt.nextClass),e.hide&&e.hide(t),t.remove(),this.removeCss()}catch(e){console.error("hidePage exp:",e.message)}},n.onShow=function(e,t){var a=this;try{if(!e)return;e.doReady&&(this.pageEvent("init",e,t),e.ready&&$.nextTick((function(){e.ready(t,e.param,a.backed)}))),e.back&&this.backed&&$.nextTick((function(){var a,s,o;null!==(a=t.clas("page-content"))&&void 0!==a&&null!==(s=a.dom)&&void 0!==s&&s.scrollTop&&(t.clas("page-content").dom.scrollTop=null!==(o=e.scrollTop)&&void 0!==o?o:0),e.back(t,e.param)})),e.show&&!this.backed&&$.nextTick((function(){e.show(t,e.param)}))}catch(e){console.error("onShow ",{ex:e.message})}},n.showPage=function(e,t){t&&(t.removeClass(this.opt.nextClass),t.removeClass(this.opt.prevClass),t.hasClass("page-master")||t.hasClass("page-master-detail")?this.view.addClass("view-master-detail"):this.view.hasClass("view-master-detail")&&this.view.removeClass("view-master-detail"),t.hasClass("page-master")||t.addClass(this.opt.showClass))},n.switchPage=function(e,t){var a,s=this;if(e){var o=null,i=this.getCurrentPage();i&&((i=$(i)).hasClass("page-master")?i=null:o=this.vps.get(i.dom));var n=$.id(e.id);if(n&&(n=$(n)).hasClass("page-master")&&(i=null),!i||!n||i.dom!==n.dom){var r=t?"backward":"forward";(i||n)&&(i&&n?this.noAni?(this.noAni=!1,this.hidePage(o,i),this.onShow(e,n),this.showPage(e,n)):(this.onShow(e,n),this.aniPage(i,n,r,(function(){s.hidePage(o,i),s.showPage(e,n)}))):i?this.hidePage(o,i):n&&(this.onShow(e,n),this.showPage(e,n))),a=this.page.title,document.title!==a&&(document.title=a)}}},n.pageEvent=function(e,t,a){try{if(!t||!a)return;if(!a.length)return;var s="page"+(e[0].toUpperCase()+e.slice(1,e.length)),o="page:"+e.toLowerCase(),i={$el:a,el:a.dom};if("init"===e){if(a[0].f7PageInitialized)return a.trigger("page:reinit",i),void this.emit("pageReinit",i);a[0].f7PageInitialized=!0}a.trigger(o,i),this.app.emit(s,i)}catch(e){console.error("pageEvent exp:"+e.message)}},e}();function r(e){e||(e=a.href);var t=e.indexOf("#!");return-1!==t?t++:t=e.indexOf("#"),-1!==t?e.substring(t+1):""}function l(e){var t=e;"!"!==e[0]&&(t="!"+e),a.hash=t}$.go=function(e,t,a){void 0===t&&(t=null),void 0===a&&(a=!1),$.router.go(e,t,a)},$.back=function(e,t){void 0===t&&(t=!1),$.router.back(e,t)},e.Router=n,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["@wiajs/Router"]={});
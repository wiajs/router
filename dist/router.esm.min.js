/*!
  * wia router v0.1.1
  * (c) 2021 Sibyl Yu
  * @license MIT
  */
function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var s in a)Object.prototype.hasOwnProperty.call(a,s)&&(e[s]=a[s])}return e}).apply(this,arguments)}var t=window.location,a="auth/getCode",s="auth/getToken",o="auth/checkToken",r=function(){function r(e){var t=this;this.opt={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.wia.pub",api:"https://wia.pub",ver:"1.0.0",mode:"prod",transition:"f7-flip"},this._index=1,this.view=null,this.as={},this.ps={},this.ids=[],this.vs={},this.vps=new Map,this.url="",this.hash=[],this.splash=!1,this.getCurrentPage=function(){return $.qu("."+t.opt.showClass)},this.opt=$.assign({},this.opt,e),this.view=$("#"+this.opt.view),this.param={},this.page=null,this.lastPage=null,this.lastApp=null,$.view=this.view,$.router=this,this.splash=!0,this.lastHash="",this.hash=[],this.nextHash="",this.lastOwner="",this.lastName="",this.lastPath="",this.backed=!1,this.owner=this.opt.owner,this.appName=this.opt.name,this.path="";var a=new(("local"===this.opt.mode?__webpack_require__("./src/index.js"):__m__("./"+this.owner+"/"+this.name+"/src/index.js")).default)({root:this.opt.root,owner:this.opt.owner,name:this.opt.name,init:!0});this.app=a,$.app=this.app,a.ready&&$.nextTick((function(){a.ready()})),a.show&&$.nextTick((function(){var e=window.location.hash;e.startsWith("#")&&(e=e.substr(1)),e.startsWith("!")&&(e=e.substr(1)),e=e.indexOf("?")>-1?e.replace(/\?\S*/,""):e;var t=$.urlParam();a.show(e,t),$.view.qus('a[href=""]').attr("href","javascript:;")})),window.addEventListener("hashchange",(function(e){var a=i(e.newURL),s=i(e.oldURL);console.log("router hash:"+s+" -> "+a);var o=a||"index";if(a===(o=t.repairUrl(o)))if(a!==s){t.backed=!1,t.hash=t.hash||[];var r=t.hash;!r||0===r.length||r.length>0&&r[r.length-1]!==a?(r.length>0?console.log("hash:"+r[r.length-1]+" -> "+a):console.log("hash:null -> "+a),r.push(a)):r.length>1&&r[r.length-2]===a?(t.backed=!0,console.log("back hash:"+r[r.length-2]+" <- "+a),r.pop()):r.length>0&&r[r.length-1]===a&&console.log("same hash: "+a),t.routeTo(r[r.length-1],t.param,t.refresh),t.refresh=!1,t.param=null,t.nextHash=""}else t.nextHash="";else n(o)}),!1)}var h=r.prototype;return h.go=function(e,a,s){void 0===a&&(a=null),void 0===s&&(s=!1),e=e||"index",e=this.repairUrl(e),i(t.href)===e?(this.nextHash=i(e),this.hash[this.hash.length-1]!==this.nextHash&&this.hash.push(this.nextHash),this.routeTo(e,a,s)):(this.param=a,this.refresh=s,this.nextHash=e,n(e))},h.repairUrl=function(e){var t="";if(!e)return"";try{if(t=e,"/"===e)t="/";else if("~"===e)t="/"+this.owner+"/"+this.appName+"/index";else if(e.startsWith("./")&&this.path)t="/"+this.owner+"/"+this.appName+"/"+this.path+"/"+e.substr(2);else if(e.startsWith("/")){if(e.startsWith("/")){var a=e.match(/([^/?]+)\/([^/?]+)\/?([^?]*)([\s\S]*)/);if(a){var s=a[1],o=a[2],r=a[3];s&&o&&!r&&(t="/"+s+"/"+o+"/index"+a[4])}}}else t="/"+this.owner+"/"+this.appName+"/"+e;(t=(t=t.endsWith("/")?t+"index":t).replace(/\/\?/g,"/index?"))!==e&&console.log("router repairUrl:"+e+" -> "+t)}catch(e){console.error("router repairUrl exp:"+e.message)}return t},h.back=function(e,t){void 0===t&&(t=!1),this.param=e,this.refresh=t,window.history.back()},h.loaded=function(e){return $.id(e.id)||this.vs[e.id]},h.load=function(e,t){var a=this,s=null;try{s=new Promise((function(s,o){var r=e.match(/([^/]+)\/([^/]+)\/?([^?]*)/),i=null==r?void 0:r[1],n=null==r?void 0:r[2],h=null==r?void 0:r[3];i&&n&&!h&&(h="index");var l="";if(h&&h.includes("/")){var c=h.lastIndexOf("/");l=h.substr(0,c)}if(console.log("load",{owner:i,name:n,page:h,path:l}),i&&n&&h)if("local"===a.opt.mode){var p=new Promise((function(e,s){var o=a.opt.local+"/page/"+h+".html?v="+Date.now();$.get(o).then((function(s){var o=new(__webpack_require__("./src/page/"+h+".js").default)({app:a.app});o.html=s,o.param=t,o.owner=i,o.appName=n,o.url="/"+i+"/"+n+"/"+h,o.path=l,a.cachePage(o),e(o)}),(function(e){return s(e)}))})),d=new Promise((function(e,t){var s=a.opt.local+"/page/"+h+".css?v="+Date.now();$.get(s).then((function(t){e(t)}),(function(e){return t(e)}))}));Promise.all([p,d]).then((function(e){var a=e[0];a.css=e[1],a.load&&a.load(t),s(a)})).catch((function(e){return o(e)}))}else e=a.opt.cos.includes("localhost:")?a.opt.cos+"/page/"+h+".js?v="+Date.now():a.opt.cos+"/"+i+"/"+n+"/page/"+h+".js?v="+Date.now(),$.get(e).then((function(e){if(e&&e.js){var o=Object.keys(e.js)[0];e.js[o];$.M.add(e.js);var r=new($.M(o).default);r.html=e.html,r.css=e.css,r.param=t,r.owner=i,r.appName=n,r.url="/"+i+"/"+n+"/"+h,r.path=l,a.cachePage(r),r.load&&r.load(t),s(r)}}),(function(e){return o(e)}));else s("")}))}catch(e){console.error("load exp:"+e.message)}return s},h.switchApp=function(e,t,a){var s=this;if(e===this.owner&&t===this.appName)return a!==this.path&&(this.path=a),Promise.resolve(!0);this.getToken(e,t).then((function(o){if(o){e&&(s.owner!==s.lastOwner&&(s.lastOwner=s.owner),s.owner=e),t&&(s.appName!==s.lastName&&(s.lastName=s.appName),s.appName=t),a&&(s.path!==s.lastPath&&(s.lastPath=s.path),s.path=a);var r=s.findApp(e,t);if(!r){var i=null;i="local"===s.opt.mode?__webpack_require__("./src/index.js"):__m__("./"+s.owner+"/"+s.name+"/src/index.js"),r=new i.default({root:s.opt.root,owner:s.opt.owner,name:s.opt.name,init:!1}),s.as[e+"."+t]=r,s.lastPage=null,s.page=null,$.lastPage=null,$.page=null,r.ready&&$.nextTick((function(){r.ready()}))}return s.lastApp=s.app,s.lastApp.hide&&$.nextTick((function(){s.lastApp.hide()})),s.app=r,r.show&&$.nextTick((function(){r.show(),$.view.qus('a[href=""]').attr("href","javascript:;")})),!0}return!1})).catch((function(e){return console.log("switchApp err:",e),!1}))},h.getToken=function(e,t){var a=this,o=this;return new Promise((function(r,i){var n="",h=e+"/"+t+"/token";try{var l=$.store.get(h);a.checkToken(e,t,l).then((function(i){i?($.app.token=l,r(l)):(l=$.app.token,$.app.token="",a.getCode(l).then((function(a){a?$.get(o.opt.api+"/"+e+"/"+t+"/"+s,"code="+a).then((function(e){e&&(200===e.code?(l=e.data.token,$.app.token=l,$.store.set(h,l),n=l):console.error("getToken error",{r:e})),r(n)})).catch(r(n)):(console.error("getToken fail! no code."),r(n))})))}))}catch(e){console.error("getToken exp:",e.message)}return n}))},h.checkToken=function(e,t,a){var s=this;return new Promise((function(r,i){var n=!1;try{a?$.get(s.opt.api+"/"+e+"/"+t+"/"+o,"token="+a).then((function(e){if(200===e.code){e.data.expire;n=e.data.res}r(n)})).catch(r(n)):r(n)}catch(e){console.error("checkToken exp:",e.message),r(n)}}))},h.getCode=function(e){var t=this;return new Promise((function(s,o){var r="";try{$.get(t.opt.api+"/"+a,"token="+e).then((function(t){200===t.code?r=t.data:console.error("getCode fail.",{token:e,rs:t}),s(r)})).catch(s(r))}catch(e){console.error("getCode exp:",e.message),s(r)}}))},h.addCss=function(e){var t="css-"+e.id,a=$.id(t);a||((a=document.createElement("style")).id=t,a.innerHTML=e.css,$("head").append(a))},h.removeCss=function(e){var t="css-"+e.id,a=$.id(t);a&&$(a).remove()},h.routeTo=function(e,t,a){var s=this;console.log("routeTo ",{url:e,param:t,refresh:a});var o=this.findPage(e,t,a);o?this.to(o,a):this.load(e,t).then((function(r){(o=s.findPage(e,t,a))&&s.to(o,a)}))},h.to=function(e,t){var a=this;e?this.switchApp(e.owner,e.appName,e.path).then((function(s){if(s){var o,r,i;a.lastPage=a.page,a.lastPage&&a.lastPage.scrollTop&&(a.lastPage.scrollTop=null!==(o=null===(r=a.lastPage.view.class("page-content"))||void 0===r||null===(i=r.dom)||void 0===i?void 0:i.scrollTop)&&void 0!==o?o:0),a.page=e,$.page=a.page,$.lastPage=a.lastPage;var n=a.ids;a.backed=!1,n.length>1&&n[n.length-2]===e.id?(a.backed=!0,console.log("to back id:"+e.id+" <- "+n[n.length-1]),n.pop()):n.length>0&&n[n.length-1]===e.id?console.log("to same id: "+e.id):(0===n.length||n.length>0&&n[n.length-1]!==e.id)&&(n.length>0?console.log("to id:"+n[n.length-1]+" -> "+e.id):console.log("to id:null -> "+e.id),n.push(e.id));var h=function(t){var s,o;e.doReady=!1;var r=$.id(e.id);if(!r&&(!(r=a.vs[e.id])&&t&&(r=t,a.vs[e.id]=r,e.doReady=!0),r&&a.view)){a.addCss(e);var i=$(r),n=i.hasClass("page-master");(a.backed||n)&&a.view.hasChild()?(a.opt.className&&i.addClass(""+a.opt.className),a.opt.prevClass&&!n&&i.addClass(""+a.opt.prevClass),a.view.dom.insertBefore(r,a.view.lastChild().dom)):(a.opt.className&&i.addClass(""+a.opt.className),a.opt.nextClass&&!n&&i.addClass(""+a.opt.nextClass),a.view.dom.appendChild(r))}e.el!==r&&(e.el=r),e.dom!==r&&(e.dom=r),(null===(s=e.$el)||void 0===s?void 0:s.dom)!==r&&(e.$el=$(r)),(null===(o=e.view)||void 0===o?void 0:o.dom)!==r&&(e.view=e.$el),a.nextHash&&a.nextHash!==a.hash[a.hash.length-1]||a.switchPage(e,a.backed)};if(t){var l=$.id(e.id);l&&$.remove(l),(l=a.vs[e.id])&&delete a.vs[e.id]}a.loaded(e)?h():function(t,s){if(void 0===s&&(s=""),t)throw t;var o=$(s);o.dom.id=e.id,e.view=o,e.$el=o,e.el=o.dom,e.dom=o.dom,a.vps.set(e.dom,e),h(e.dom)}(null,e.html)}})).catch((function(e){return console.error("to err:",e)})):console.error("route to null page.")},h.parseUrl=function(e){var t={url:e};try{var a=e.indexOf("?");if(a>=0)if(t.url=e.substr(0,a),t.search=e.substr(a+1),t.search)t.param={},t.search.split("&").forEach((function(e){(a=e.indexOf("="))>0&&(t.param[e.substr(0,a)]=e.substr(a+1))}));t.url=this.repairUrl(t.url);var s=e.match(/([^/]+)\/([^/]+)\/([^?]+)/);s&&(t.path=s[3]),e!==t.url&&console.log("router parseUrl url:"+e+" -> "+t.url+" path:"+t.path)}catch(e){console.error("router parseUrl exp:"+e.message)}return t},h.findPage=function(t,a,s){var o=null,r=this.parseUrl(t),i=this.ps[r.url];return i?(r.param?i.param=e({},r.param):i.param={},a&&$.assign(i.param,a),i.lastSearch=i.search,i.search=r.search,i.refresh=s,o=i):console.log("findPage not find!",{url:t}),o},h.findApp=function(e,t,a,s){var o=null,r=this.as[e+"."+t];return r?(r.param={},a&&$.assign(r.param,a),r.reload=s,o=r):console.log("findApp not find!",{owner:e,name:t}),o},h.cachePage=function(e){try{if(!e)throw new Error("page is empty!");if(!e.url)throw new Error("page's url is empty!");return e.id=""+e.url.replace(/\//g,"-"),e.id.startsWith("-")&&(e.id=e.id.substr(1)),e.ready=e.ready||$.noop,e.router=this,this.ps[e.url]=e,this}catch(e){console.error("router.cachePage exp: "+e.message)}},h.aniPage=function(e,t,a,s){var o=this,r="router-transition-"+(a||"forward")+" router-transition";if($.device.ios)t.animationEnd((function(){o.view.removeClass(r),s&&s()}));else{var i=t;"backward"===a&&(i=e),i.animationEnd((function(){o.view.removeClass(r),s&&s()}))}this.view.addClass(r)},h.hidePage=function(e,t){if(t&&e)try{t.removeClass(this.opt.showClass),t.removeClass(this.opt.prevClass),t.removeClass(this.opt.nextClass),e.hide&&e.hide(t),t.remove(),this.removeCss(e)}catch(e){console.error("hidePage exp:",e.message)}},h.onShow=function(e,t){var a=this;try{if(!e)return;e.doReady&&e.ready&&$.nextTick((function(){try{e.ready(t,e.param,a.backed)}catch(e){console.log("page ready exp!",{exp:e})}a.pageEvent("init",e,t),$.fastLink()})),e.back&&this.backed&&$.nextTick((function(){var a,s,o;null!==(a=t.class("page-content"))&&void 0!==a&&null!==(s=a.dom)&&void 0!==s&&s.scrollTop&&(t.class("page-content").dom.scrollTop=null!==(o=e.scrollTop)&&void 0!==o?o:0),e.back(t,e.param)})),e.show&&!this.backed&&$.nextTick((function(){e.show(t,e.param)}))}catch(e){console.error("onShow ",{ex:e.message})}},h.showPage=function(e,t){t&&(t.removeClass(this.opt.nextClass),t.removeClass(this.opt.prevClass),t.hasClass("page-master")||t.hasClass("page-master-detail")?this.view.addClass("view-master-detail"):this.view.hasClass("view-master-detail")&&this.view.removeClass("view-master-detail"),t.hasClass("page-master")||t.addClass(this.opt.showClass))},h.switchPage=function(e,t){var a=this;if(e){var s=null,o=this.getCurrentPage();o&&((o=$(o)).hasClass("page-master")?o=null:s=this.vps.get(o.dom));var r=$.id(e.id);if(r&&(r=$(r)).hasClass("page-master")&&(o=null),!o||!r||o.dom!==r.dom){var i=t?"backward":"forward";(o||r)&&(o&&r?this.noAni?(this.noAni=!1,this.hidePage(s,o),this.onShow(e,r),this.showPage(e,r)):(this.onShow(e,r),this.aniPage(o,r,i,(function(){a.hidePage(s,o),a.showPage(e,r)}))):o?this.hidePage(s,o):r&&(this.onShow(e,r),this.showPage(e,r))),function(e){if(document.title===e)return;document.title=e}(this.page.title)}}},h.pageEvent=function(e,t,a){try{if(!t||!a)return;if(!a.length)return;var s="page"+(e[0].toUpperCase()+e.slice(1,e.length)),o="page:"+e.toLowerCase(),r={$el:a,el:a.dom};if("init"===e){if(a[0].f7PageInitialized)return a.trigger("page:reinit",r),void this.emit("pageReinit",r);a[0].f7PageInitialized=!0}a.trigger(o,r),this.app.emit(s,r)}catch(e){console.error("pageEvent exp:"+e.message)}},r}();function i(e){e||(e=t.href);var a=e.indexOf("#!");return-1!==a?a++:a=e.indexOf("#"),-1!==a?e.substring(a+1):""}function n(e){var a=e;"!"!==e[0]&&(a="!"+e),t.hash=a}$.go=function(e,t,a){void 0===t&&(t=null),void 0===a&&(a=!1),$.router.go(e,t,a)},$.back=function(e,t){void 0===t&&(t=!1),$.router.back(e,t)};export{r as Router};
/*!
  * wia router v0.1.11
  * (c) 2020 Sibyl Yu
  * @license MIT
  */
function _extends(){return(_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var s=arguments[e];for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(t[o]=s[o])}return t}).apply(this,arguments)}var location=window.location,API={getCode:"auth/getCode",getToken:"auth/getToken",checkToken:"auth/checkToken"},Router=function(){function Router(t){var e=this;this.opt={view:"wia-view",style:"wia-style",splashTime:1e3,className:"page",nextClass:"page-next",prevClass:"page-previous",showClass:"page-current",cos:"https://cos.nuoya.net",api:"https://wia.pub",ver:"1.0.0",mode:"prod",transition:"f7-flip"},this._index=1,this.view=null,this.rs=[],this.ps={},this.url="",this.hash=[],this.splash=!1,this.getCurrentPage=function(){return $.qu("."+e.opt.showClass)},this.opt=$.assign({},this.opt,t),this.app=this.opt.app,this.app.router=this,this.view=$("#"+this.opt.view),this.style=null,this.lastStyle=null,this.param={},this.page=null,this.lastPage=null,$.view=this.view,$.router=this,this.splash=!0,this.lastHash="",this.hash=[],this.nextHash="",this.owner=this.opt.owner,this.name=this.opt.name,this.path="",this.lastOwner="",this.lastName="",this.lastPath="",this.backed=!1,window.addEventListener("hashchange",(function(t){var s=getHash(t.newURL),o=getHash(t.oldURL);console.log("router hash:"+o+" -> "+s);var a=s||"index";if(s===(a=e.repairUrl(a)))if(s!==o){e.backed=!1,e.hash=e.hash||[];var r=e.hash;!r||0===r.length||r.length>0&&r[r.length-1]!==s?(r.length>0?console.log("hash:"+r[r.length-1]+" -> "+s):console.log("hash:null -> "+s),r.push(s)):r.length>1&&r[r.length-2]===s?(e.backed=!0,console.log("back hash:"+r[r.length-2]+" <- "+s),r.pop()):r.length>0&&r[r.length-1]===s&&console.log("same hash: "+s),e.routeTo(r[r.length-1],e.param,e.refresh),e.refresh=!1,e.param=null,e.nextHash=""}else e.nextHash="";else setHash(a)}),!1)}var _proto=Router.prototype;return _proto.go=function(t,e,s){void 0===e&&(e=null),void 0===s&&(s=!1),t=t||"index",t=this.repairUrl(t),getHash(location.href)===t?(this.nextHash=getHash(t),this.hash[this.hash.length-1]!==this.nextHash&&this.hash.push(this.nextHash),this.routeTo(t,e,s)):(this.param=e,this.refresh=s,this.nextHash=t,setHash(t))},_proto.repairUrl=function(t){var e="";if(!t)return"";try{if(e=t,"/"===t)e="/";else if("~"===t)e="/"+this.owner+"/"+this.name+"/index";else if(t.startsWith("./"))e="/"+this.owner+"/"+this.name+"/"+this.path+"/"+t.substr(2);else if(t.startsWith("/")){if(t.startsWith("/")){var s=t.match(/([^/]+)\/([^/]+)\/?([^?]*)([\s\S]*)/);if(s){var o=s[1],a=s[2],r=s[3];o&&a&&!r&&(e="/"+o+"/"+a+"/index"+s[4])}}}else e="/"+this.owner+"/"+this.name+"/"+t;(e=(e=e.endsWith("/")?e+"index":e).replace(/\/\?/g,"index?"))!==t&&console.log("router repairUrl:"+t+" -> "+e)}catch(t){console.error("router repairUrl exp:"+t.message)}return e},_proto.back=function(t,e){void 0===e&&(e=!1),this.param=t,this.refresh=e,window.history.back()},_proto.loaded=function(t){return $.id(t.id)||this.ps[t.id]},_proto.load=function load(url,param){var _this2=this,R=null;try{R=new Promise((function(res,rej){var ps=url.match(/([^/]+)\/([^/]+)\/?([^?]*)/),owner=null==ps?void 0:ps[1],name=null==ps?void 0:ps[2],page=null==ps?void 0:ps[3];owner&&name&&!page&&(page="index");var path="";if(page&&page.includes("/")){var _pos=page.lastIndexOf("/");path=page.substr(0,_pos)}console.log("load",{owner:owner,name:name,page:page,path:path}),owner&&(_this2.owner!==_this2.lastOwner&&(_this2.lastOwner=_this2.owner),_this2.owner=owner),name&&(_this2.name!==_this2.lastName&&(_this2.lastName=_this2.name),_this2.name=name),path&&(_this2.path!==_this2.lastPath&&(_this2.lastPath=_this2.path),_this2.path=path),owner&&name&&page?_this2.switchApp(owner,name,path).then((function(rs){if(rs)if("local"===_this2.opt.mode){var appJs=null,appCss=null,pgHtml=new Promise((function(t,e){var s=_this2.opt.local+"/"+owner+"/"+name+"/page/"+page+".html?v="+Date.now();$.get(s).then((function(e){var s=new(__webpack_require__("./src/page/"+page+".js").default)({app:_this2.app});s.html=e,s.url="/"+owner+"/"+name+"/"+page,s.param=param,_this2.push(s),t(s)}),(function(t){return e(t)}))})),pgCss=new Promise((function(t,e){var s=_this2.opt.local+"/page/"+page+".css?v="+Date.now();$.get(s).then((function(e){t(e)}),(function(t){return e(t)}))}));appJs?Promise.all([appJs,appCss]).then((function(rs){owner&&(_this2.owner!==_this2.lastOwner&&(_this2.lastOwner=_this2.owner),_this2.owner=owner),name&&(_this2.name!==_this2.lastName&&(_this2.lastName=_this2.name),_this2.name=name),_this2.rs=[],eval(rs[0]);var appcss=rs[1];Promise.all([pgHtml,pgCss]).then((function(t){var e=t[0];e.css=t[1],e.load&&e.load(param),res(e)})).catch((function(t){return rej(t)}))})).catch((function(t){return rej(t)})):Promise.all([pgHtml,pgCss]).then((function(t){var e=t[0];e.css=t[1],e.load&&e.load(param),res(e)})).catch((function(t){return rej(t)}))}else{url=url.substring(1,pos)+"/page/"+page;var pgurl=_this2.opt.cos+"/"+url+".js?v="+_this2.opt.ver;$.get(pgurl).then((function(t){var e=JSON.parse(t);if(e&&e.js){var s=Object.keys(e.js)[0];e.js[s];$._m.add(e.js);var o=new($._m(s).default);o.html=e.html,o.css=e.css,o.param=param,$.router.push(o),o.load&&o.load(param),res(o)}}),(function(t){return rej(t)}))}})):res("")}))}catch(t){console.error("load exp:"+t.message)}return R},_proto.switchApp=function(t,e,s){var o=this;return new Promise((function(s,a){var r=!1;try{t===o.owner&&e===o.name?s(!0):o.getToken().then((function(t){t&&(r=!0),s(r)}))}catch(t){console.log("getToken exp:",t.message),s(r)}}))},_proto.getToken=function(t,e){var s=this,o=this;return new Promise((function(a,r){var n="",i=t+"/"+e+"/token";try{var h=$.store.get(i);s.checkToken(t,e,h).then((function(r){r?($.app.token=h,a(h)):(h=$.app.token,$.app.token="",s.getCode(h).then((function(s){s?$.get(o.opt.api+"/"+t+"/"+e+"/"+API.getToken,"code="+s).then((function(t){t&&(console.log("getToken",{r:t}),200===t.code?(h=t.data.token,$.app.token=h,$.store.set(i,h),n=h):console.error("getToken error",{r:t})),a(n)})).catch(a(n)):(console.error("getToken fail! no code."),a(n))})))}))}catch(t){console.error("getToken exp:",t.message)}return n}))},_proto.checkToken=function(t,e,s){var o=this;return new Promise((function(a,r){var n=!1;try{s?$.get(o.opt.api+"/"+t+"/"+e+"/"+API.checkToken,"token="+s).then((function(t){if(console.log("checkToken",{token:s,rs:t}),200===t.code){t.data.expire;n=t.data.res}a(n)})).catch(a(n)):a(n)}catch(t){console.error("checkToken exp:",t.message),a(n)}}))},_proto.getCode=function(t){var e=this;return new Promise((function(s,o){var a="";try{$.get(e.opt.api+"/"+API.getCode,"token="+t).then((function(e){console.log("getCode",{token:t,rs:e}),200===e.code?a=e.data:console.error("getCode fail.",{token:t,rs:e}),s(a)})).catch(s(a))}catch(t){console.error("getCode exp:",t.message),s(a)}}))},_proto.addCss=function(t){var e=document.createElement("style");this.style&&(this.lastStyle=this.style),this.style=e,$("head").append(e),this.style.innerHTML=t},_proto.removeCss=function(){this.lastStyle&&this.lastStyle.parentNode&&this.lastStyle.parentNode.removeChild(this.lastStyle)},_proto.routeTo=function(t,e,s){var o=this;console.log("routeTo ",{url:t,param:e,refresh:s});var a=this.findRoute(t,e,s);a?this.to(a,s):this.load(t,e).then((function(r){(a=o.findRoute(t,e,s))&&o.to(a,s)}))},_proto.to=function(t,e){var s=this;if(!t)return console.error("route to null page."),this;this.lastPage=this.page,this.lastPage&&(this.lastPage.scrollTop=this.lastPage.el.clas("page-content").dom.scrollTop),this.page=t,$.page=this.page,$.lastPage=this.lastPage,this.lasts=this.lasts||[];var o=this.lasts;this.backed=!1,o.length>1&&o[o.length-2].id===t.id?(this.backed=!0,console.log("to back id:"+o[o.length-2].id+" <- "+this.lastPage.id),o.pop()):o.length>0&&o[o.length-1].id===t.id?console.log("to same id: "+t.id):(0===o.length||o.length>0&&o[o.length-1].id!==t.id)&&(o.length>0?console.log("to id:"+o[o.length-1].id+" -> "+t.id):console.log("to id:null -> "+t.id),o.push(this.page));var a=function(e){t.doReady=!1;var o=$.id(t.id);if(!o&&(!(o=s.ps[t.id])&&e&&(o=e,s.ps[t.id]=o,t.doReady=!0),o)){if(s.view){s.addCss(t.css);var a=$(o);s.backed&&s.view.hasChild()?(s.opt.className&&a.addClass(""+s.opt.className),s.opt.prevClass&&a.addClass(""+s.opt.prevClass),s.view.dom.insertBefore(o,s.view.dom.children[0])):(s.opt.className&&a.addClass(""+s.opt.className),s.opt.nextClass&&a.addClass(""+s.opt.nextClass),s.view.dom.appendChild(o))}t.doReady&&$.fastLink()}t.page=o,t.el=$(o),s.nextHash&&s.nextHash!==s.hash[s.hash.length-1]||s.switchPage(s.lastPage,t,s.backed)};if(e){var r=$.id(t.id);r&&$.remove(r),(r=this.ps[t.id])&&delete this.ps[t.id]}var n=this.loaded(t);this.getCurrentPage();return n?a():function(e,s){if(void 0===s&&(s=""),e)throw e;var o=$(s);t.view=o,o.dom.id=t.id,a(o.dom)}(null,t.html),this},_proto.parseUrl=function(t){var e={url:t};try{var s=t.indexOf("?");if(s>=0)if(e.url=t.substr(0,s),e.search=t.substr(s+1),e.search)e.param={},e.search.split("&").forEach((function(t){(s=t.indexOf("="))>0&&(e.param[t.substr(0,s)]=t.substr(s+1))}));e.url=this.repairUrl(e.url),t!==e.url&&console.log("router parseUrl url:"+t+" -> "+e.url)}catch(t){console.error("router parseUrl exp:"+t.message)}return e},_proto.findRoute=function(t,e,s){var o=null,a=this.parseUrl(t),r=this.rs.find((function(t){return t.url===a.url}));return r?(a.param?r.param=_extends({},a.param):r.param={},e&&$.assign(r.param,e),r.path=a.path,r.url=t,r.lastSearch=r.search,r.search=a.search,r.refresh=s,o=r):console.log("findRoute not find!",{url:t}),o},_proto.push=function(t){try{if(!t)throw new Error("page is empty!");if(!t.url)throw new Error("page's url is empty!");return this.rs.find((function(e){return e.url===t.url}))?void console.info("push r.url:"+t.url+" exist."):(t.id=""+t.url.replace(/\//g,"-"),t.id.startsWith("-")&&(t.id=t.id.substr(1)),t.ready=t.ready||$.noop,t.router=this,this.rs.push(t),console.debug("router push r.url:"+t.url+" succ."),this)}catch(t){alert("router.push exp: "+t.message)}},_proto.aniPage=function(t,e,s,o){var a=this,r="router-transition-"+(s||"forward")+" router-transition";if($.device.ios)e.animationEnd((function(){a.view.removeClass(r),o&&o()}));else{var n=e;"backward"===s&&(n=t),n.animationEnd((function(){a.view.removeClass(r),o&&o()}))}this.view.addClass(r)},_proto.hidePage=function(t,e){e&&t&&(e.removeClass(this.opt.showClass),e.removeClass(this.opt.prevClass),e.removeClass(this.opt.nextClass),t.hide&&t.hide(e),t.lastPage&&(this.ps[t.lastPage.id]=e),e.remove(),this.removeCss())},_proto.onShow=function(t,e){var s=this;try{if(!t)return;t.doReady&&t.ready&&$.nextTick((function(){t.ready(e,t.param,s.backed)})),t.back&&this.backed&&$.nextTick((function(){t.scrollTop&&(e.clas("page-content").dom.scrollTop=t.scrollTop),t.back(e,t.param)})),t.show&&!this.backed&&$.nextTick((function(){t.show(e,t.param)}))}catch(t){console.error("onShow ",{ex:t.message})}},_proto.showPage=function(t,e){e&&(e.removeClass(this.opt.nextClass),e.removeClass(this.opt.prevClass),e.addClass(this.opt.showClass))},_proto.switchPage=function(t,e,s){var o=this;if(e){var a=this.getCurrentPage();a&&(a=$(a));var r=$.id(e.id);if(r&&(r=$(r)),!a||!r||a.dom!==r.dom){var n=s?"backward":"forward";(a||r)&&(a&&r?this.noAni?(this.noAni=!1,this.hidePage(t,a),this.onShow(e,r),this.showPage(e,r)):(this.onShow(e,r),this.aniPage(a,r,n,(function(){o.hidePage(t,a),o.showPage(e,r)}))):a?this.hidePage(t,a):r&&(this.onShow(e,r),this.showPage(e,r))),setTitle(this.page.title)}}},Router}();function getHash(t){t||(t=location.href);var e=t.indexOf("#!");return-1!==e?e++:e=t.indexOf("#"),-1!==e?t.substring(e+1):""}function setHash(t){var e=t;"!"!==t[0]&&(e="!"+t),location.hash=e}function setTitle(t){document.title!==t&&(/MicroMessenger/i.test(navigator.userAgent)?setTimeout((function(){document.title=t;var e=document.createElement("iframe");e.style.display="none",e.onload=function(){setTimeout((function(){document.body.removeChild(e)}),0)},document.body.appendChild(e)}),0):document.title=t)}$.go=function(t,e,s){void 0===e&&(e=null),void 0===s&&(s=!1),$.router.go(t,e,s)},$.back=function(t,e){void 0===e&&(e=!1),$.router.back(t,e)};export{Router};